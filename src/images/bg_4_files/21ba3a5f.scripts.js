(function(){angular.module("auth",["auth.interceptor"])}).call(this),function(){angular.module("auth.interceptor",[]).factory("authErrorInterceptor",["$q","$rootScope",function(a,b){return function(c){return c.then(angular.identity,function(c){return 401===c.status&&b.$broadcast("event:loginRequired"),a.reject(c)})}}]).config(["$httpProvider",function(a){return a.responseInterceptors.push("authErrorInterceptor")}])}.call(this),function(){angular.module("auth").factory("activateDialog",["dialog",function(a){var b;return b=null,{open:function(c){return this.close(),a.fromUrl("/scripts/auth/dialog-activate.html",{controller:"ActivateDialogCtrl",scope:c}).then(function(a){return b=a,a.open()})},close:function(){return b?b.close():void 0}}}]).controller("ActivateDialogCtrl",["$scope","activateDialog","domainConfig","dialog","me",function(a,b,c,d,e){return a.accountSettingsUrl=c.accountSettingsUrl,a.sent=!1,a.resend=function(c){return c.preventDefault(),e.activate(function(){return a.sent=!0},function(a){return a.data.message?(b.close(),d.message(a.data.message)):void 0})}}])}.call(this),function(){angular.module("auth").controller("LoginDialogCtrl",["$scope","$http","$window","$location","domainConfig","oauth",function(a,b,c,d,e,f){return a.weiboLogin=function(){return f.register("sina")},a.loginUrls={mail:function(){return e.loginUrl()}},a.signupUrl=function(){return e.signupUrl()}}])}.call(this),function(){angular.module("auth").factory("loginDialog",["dialog",function(a){var b;return b=null,{open:function(c){return this.close(),a.fromUrl("/scripts/auth/dialog.html",{controller:"LoginDialogCtrl",scope:c}).then(function(a){return b=a,a.open()})},close:function(){return b?b.close():void 0}}}])}.call(this);var app=angular.module("columnWebApp",["auth","blueimp.fileupload","placeholderShim","angularytics","ngAnimate","ngRoute","ngTouch","ngResource","ngSanitize"]);Raven.config("https://4d88938215db490688b7f363fca77849@crash2.zhihu.com/4").install(),function(){app.run(["$browser","$http","fileUpload",function(a,b,c){var d,e;return d=b.defaults,e={},e[d.xsrfHeaderName]=a.cookies()[d.xsrfCookieName],angular.extend(c.defaults,{disableImageResize:!1,maxFileSize:5e6,acceptFileTypes:/(\.|\/)(jpe?g|png)$/i,headers:e,send:function(a,b){return delete b.headers["Content-Disposition"]},messages:{acceptFileTypes:"仅支持 jpg、png 格式图片。",maxFileSize:"抱歉，请上传大小为 5M 以下的图片文件"}})}]),app.constant("siteName","知乎专栏"),app.constant("siteConfig",{oauthUrl:"https://www.zhihu.com/oauth/callback/wechat_zhuanlan?",tipjarOpenKey:"openTipjar"}),app.factory("domainConfig",["$location",function(a){var b;b=location.hostname.replace(/\w+\./,"");try{document.domain=b}catch(c){}return{wwwDomain:"www."+b,columnDomain:"zhuanlan."+b,uploadDomain:location.hostname,uploadUrl:"/api/upload",avatarUploadUrl:"//upload."+b+"/upload_avatar",qqOAuthUrl:"//www."+b+"/oauth/redirect/login/qqconn",sinaOAuthUrl:"//www."+b+"/oauth/redirect/login/sina",accountSettingsUrl:"//www."+b+"/settings/account",loginUrl:function(){return"http://www."+b+"/signin?next="+decodeURIComponent(a.absUrl())},signupUrl:function(){return"http://www."+b+"/signup?next="+decodeURIComponent(a.absUrl())}}}]),app.run(function(){return angular.element(document.documentElement).removeClass("no-js")}),app.run(["$location","$route","$rootScope","$timeout",function(a,b,c,d){var e;return e=a.url,a.url=function(b,f){var g;return f&&(g=c.$on("$locationChangeStart",function(a){return a.preventDefault(),history.replaceState(null,null,b),c.$broadcast("routeSilentChangeSuccess"),d(function(){return g()})})),e.apply(a,[b])}}]),app.run(["mediator","$window","$rootScope",function(a,b,c){return b.ZH=b.ZH||{},b.ZH.cm=function(b,d){return c.$apply(function(){return a.publish(b,d)})}}]),app.run(["$location","$http",function(a,b){var c;return c=a.search().group_id,c?(b.put("/api/notification/groups/"+c+"/read"),a.search({}).replace()):void 0}]),app.config(["AngularyticsProvider",function(a){var b;return b=["Google"],"localhost"===location.hostname&&b.push("Console"),a.setEventHandlers(b)}]).run(["Angularytics",function(a){var b;return a.init(),b=angular.element(document),b.on("videobox:open",function(b,c){return a.trackEvent("video","click_videobox_open")}),b.on("lightbox:zoomin",function(b){return a.trackEvent("image","click_lightbox_zoomin")})}]),app.config(["$compileProvider",function(a){return a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|javascript):/)}]),app.run(["$rootScope",function(a){var b,c;return c=/iPhone|iPad/.test(navigator.userAgent),(b=!c)?(NProgress.configure({easing:"ease-out",minimum:.26,trickleRate:.15,trickleSpeed:200,showSpinner:!1}),a.$on("$routeChangeStart",function(){return NProgress.start()}),a.$on("$routeChangeError",function(){return NProgress.done()}),a.$on("$routeChangeSuccess",function(){return NProgress.done()})):void 0}]),app.run(["$rootScope",function(a){return a.$on("$routeChangeSuccess",function(){return"function"==typeof window.getSelection?window.getSelection().removeAllRanges():void 0})}]),app.run(["$rootScope",function(a){return a.supportTouch="ontouchstart"in document}]),app.run(["$browser","$http",function(a,b){var c;return c=b.defaults,$.ajaxPrefilter(function(b){var d,e;return b.processData&&"get"!==(e=b.type)&&"head"!==e&&"options"!==e&&(d=a.cookies()[c.xsrfCookieName],d&&(b.headers=b.headers||{},b.headers[c.xsrfHeaderName]=d)),void(b.disableXSRFHeader&&delete b.headers[c.xsrfHeaderName])})}]),app.run(["$rootScope","$window","wx",function(a,b,c){var d,e,f;return f=e=!1,d=function(){return f&&e?c.init():void 0},b.addEventListener("load",function(){return f=!0,d()}),a.$on("$routeChangeSuccess",function(){return e=!0,d()})}]),app.run(["$rootScope","me","zap",function(a,b,c){return b.$promise.then(function(a){return c.init(a.uid,a.hash)},function(){return c.init()}),a.$on("$routeChangeSuccess",function(){return c.trackPageShow()})}])}.call(this),function(){app.config(["$routeProvider","$locationProvider",function(a,b){var c,d,e,f,g,h;return b.html5Mode(!0),g=["columnResolver",function(a){return a()}],f=["postResolver",function(a){return a()}],c=["authResolver",function(a){return a()}],h=["viewPostResolver",function(a){return a()}],d=["$location","$q",function(a,b){var c,d;return c=b.defer(),d=angular.element(document.documentElement).hasClass("lt-ie9"),d?(c.reject(),a.url("/ie")):c.resolve()}],e=["$q","columnResolver","me","$location",function(a,b,c,d){var e;return e=a.defer(),b().then(function(a){return"activated"!==a.activateState?(e.resolve(a),d.url("/403").replace()):a.creator.slug===c.slug||a.canManage?e.resolve(a):(e.reject("你没有权限访问这个页面"),d.url(a.url))}),e.promise}],a.when("/",{pageTitle:"知乎专栏 - 随心写作，自由表达$",pageClass:"home",templateUrl:"/views/home.html",controller:"HomeCtrl"}).when("/ie",{docTitle:"请升级您的浏览器",templateUrl:"/views/ie.html"}).when("/write",{pageTitle:"写文章",pageClass:"page-write",templateUrl:"/views/post-write.html",controller:"PostWriteCtrl",disableScrollBackFixedNavbar:!0,resolve:{ieResolver:d,auth:c,draft:["Draft",function(a){return new a}]}}).when("/request",{pageTitle:"申请创建专栏",docTitle:"创建",templateUrl:"/views/column-request.html",controller:"ColumnRequestCtrl",pageClass:"page-column-request",resolve:{ieResolver:d,auth:c,noPending:["$q","$location","me",function(a,b,c){var d;return d=a.defer(),c.$promise.then(function(){return c.pendingColumns.length?(d.reject(!1),b.url("/").replace()):d.resolve(!0)}),d.promise}]}}).when("/drafts",{pageTitle:"我的草稿",pageClass:"page-drafts",templateUrl:"/views/draft-list.html",controller:"DraftsCtrl",resolve:{auth:c}}).when("/404",{pageTitle:"没有找到该页面",templateUrl:"/views/404.html",pageClass:"page-empty"}).when("/403",{pageTitle:"抱歉，没有权限访问",templateUrl:"/views/403.html",pageClass:"page-empty"}).when("/500",{pageTitle:"服务器提了一个问题",templateUrl:"/views/500.html",pageClass:"page-empty"}).when("/:columnSlug",{pageTitle:"",pageClass:"column-view",templateUrl:"/views/post-list.html",controller:"PostsCtrl",resolve:{column:g}}).when("/:columnSlug/settings",{pageTitle:"设置",templateUrl:"/views/column-settings.html",controller:"ColumnEditCtrl",resolve:{ieResolver:d,auth:c,column:e}}).when("/:columnSlug/settings/posts",{pageTitle:"专栏设置",templateUrl:"/views/column-settings-posts.html",controller:"ColumnPostsEditCtrl",resolve:{ieResolver:d,auth:c,column:e}}).when("/:columnSlug/settings/contributes",{pageTitle:"专栏设置",templateUrl:"/views/column-settings-contributes.html",controller:"ColumnContributesEditCtrl",resolve:{ieResolver:d,auth:c,column:e}}).when("/:columnSlug/settings/authors",{pageTitle:"专栏设置",templateUrl:"/views/column-settings-authors.html",controller:"ColumnAuthorsEditCtrl",resolve:{auth:c,column:e}}).when("/:columnSlug/about",{pageTitle:"关于",pageClass:"page-column-about",templateUrl:"/views/column-about.html",controller:"ColumnAboutCtrl",resolve:{column:g}}).when("/:columnSlug/followers",{pageTitle:"关注者",templateUrl:"/views/column-followers.html",controller:"ColumnFollowersCtrl",resolve:{column:g}}).when("/p/:postSlug",{pageClass:"",templateUrl:"/views/post-view.html",controller:"PostViewCtrl",pageClass:"page-post-view",resolve:{resources:["$q","$location","authResolver","postResolver","columnResolver","viewPostResolver","renderServerError",function(a,b,c,d,e,f,g){var h,i;return h=a.defer(),i={},d().then(function(a){return f(a,"post").then(function(a){return i.post=a,e(a.column,a,"simple").then(function(a){return i.column=a,h.resolve(i)})})})["catch"](function(a){switch(a.status){case 404:return h.resolve({});case 403:return h.resolve({});default:return h.reject(a)}}),h.promise}]}}).when("/p/:postSlug/edit",{pageTitle:"编辑文章",pageClass:"page-write",templateUrl:"/views/post-write.html",disableScrollBackFixedNavbar:!0,controller:"PostWriteCtrl",resolve:{ieResolver:d,auth:c,draft:["$q","$route","$location","Draft","renderServerError","viewPostResolver",function(a,b,c,d,e,f){var g;return g=a.defer(),d.get(b.current.params).$promise.then(function(a){return f(a,"draft").then(function(a){return g.resolve(a)})},function(a){switch(g.reject(a),a.status){case 404:return c.url("/404").replace();case 403:return c.url("/403").replace();case 405:return c.url("/p/"+b.current.params.postSlug).replace();case 500:return e()}}),g.promise}]}}).when("/p/:postSlug/voters",{pageClass:"",templateUrl:"/views/post-voters.html",controller:"PostVotersCtrl",pageClass:"page-post-voters",resolve:{post:["$q","$location","authResolver","postResolver","columnResolver","viewPostResolver",function(a,b,c,d,e,f){var g;return g=a.defer(),d().then(function(a){return f(a,"post").then(function(a){return e(a.column,a,"simple").then(function(b){return a.column=b,g.resolve(a)})})})["catch"](function(){return b.url("/404").replace()}),g.promise}]}}).when("/:columnSlug/:postSlug",{redirectTo:"/p/:postSlug"}).otherwise({redirectTo:"/404"})}])}.call(this),function(){app.factory("dialog",["$timeout","$rootScope","$http","$compile","$controller","$templateCache",function(a,b,c,d,e,f){var g;return g=function(a,c){var d,e;return null==c&&(c=function(){}),e=a.scope,e&&(delete a.scope,"function"==typeof e.$on&&e.$on("$destroy",function(){return d.close()})),d=new zh.ui.Dialog(a),d.on("dialogselect",function(a){return b.$apply(function(){return c.call(d,a.key)})}),d},g.confirm=function(a,b,c,d){var e,f,h;return null==d&&(d=function(){}),e={scope:a,cssClass:"confirm",buttons:{cancel:"取消",yes:"确定"}},h=angular.extend({},{title:b,content:c},e),f=g(h,function(a){return"yes"===a?d():void 0}),f.open()},g.message=function(b,c){var d,e,f;return null==c&&(c=1600),d={title:"提示信息",cssClass:"message",buttons:{}},f=angular.extend({},{content:b},d),e=g(f),a(function(){return e.close()},c),e.open()},g.fromUrl=function(a,b){return c.get(a,{cache:f}).then(function(a){var c,f,h,i,j,k;return h=angular.element(a.data),h.appendTo(document.body),k=angular.extend({},b),f=g(k),f.decorate(h[0]),f.on("afterhide",function(){return h.remove()}),j=(b.scope||h.scope()).$new(),d(h)(j),i={$scope:j,element:h,dlg:f},angular.extend(i,b.resolve),c=e(b.controller,i),h.data("$ngControllerController",c),f})},g}])}.call(this),function(){app.directive("uiConfirm",["dialog",function(a){return{restrict:"A",link:function(b,c,d){return c.on("click",function(){var e;return e=d.confirmTitle||d.title||c.text()||"提示信息",a.confirm(b,e,d.confirmMessage,function(){return b.$eval(d.uiConfirm)})})}}}])}.call(this),function(){app.directive("uiDialog",["dialog","$parse",function(a,b){return{restrict:"A",link:function(c,d,e){var f,g;return g={scope:c,autoDestroy:!1},f=a(g),f.decorate(d[0]),f.on("afterhide",function(){return c.$apply(function(){var a;return"function"==typeof(a=b(e.open)).assign?a.assign(c,!1):void 0})}),c.$watch(function(){return d.height()},function(){return f.isOpen()?f.reposition():void 0}),c.$watch(e.open,function(a){return a?f.open():f.close()})}}}])}.call(this),function(){app.factory("reportService",["dialog","$timeout",function(a,b){return function(c,d,e){return a.fromUrl("/scripts/report/dialog-report.html",{controller:"ReportDialogCtrl",scope:e,resolve:{entry:c,type:d}}).then(function(a){return a.open(),b(function(){return a.reposition()})})}}])}.call(this),function(){app.controller("ReportDialogCtrl",["$scope","dialog","$http","entry","type",function(a,b,c,d,e){var f,g,h,i,j;return f={spam:"广告等垃圾信息",abuse:"不友善内容",illegality:"违反法律法规的内容",politics:"政治敏感",repost:"不规范转载",direction:"不符合专栏写作方向",tipjar:"滥用专栏赞赏功能"},g={post:{title:"为什么举报这篇文章？",reasons:["abuse","spam","illegality","politics","repost"]},comment:{title:"为什么举报这个评论？",reasons:["abuse","spam","illegality","politics"]},column:{title:"为什么举报这个专栏？",reasons:["abuse","spam","illegality","politics"]}},a.post&&(("user"!==(null!=(j=a.post.column)?j.type:void 0)||a.contributes.length)&&g.post.reasons.push("direction"),"activated"===a.post.tipjarState&&g.post.reasons.push("tipjar")),a.Reasons=f,a.ReasonsMap=g,i=""+d.href+"/report",h=a.formData={detail:"",reason:""},a.config=g[e],a.validate=function(){return this.errorShow=!0,this.reportForm.$valid},a.post=function(a){return c.post(i,h).success(function(a){return b.message(a.message||"您的举报我们已经收到，处理完成后会私信告知处理结果")}).error(function(a){return b.message(a.message||"举报失败，重新尝试一下？")})},a.submit=function(b){return a.validate()?a.post(h):(b.preventDefault(),b.stopPropagation())}}])}.call(this),function(){app.factory("contributeService",["dialog",function(a){var b;return b=null,{open:function(c,d){return a.fromUrl("/scripts/contribute/dialog.html",{controller:"ContributeDialogCtrl",scope:d,resolve:{entry:c}}).then(function(a){return b=a,a.open()})},close:function(){return b?b.close():void 0}}}])}.call(this),function(){app.controller("ContributeDialogCtrl",["$scope","$resource","$interpolate","$timeout","contributeService","dialog","myPost","entry","element",function(a,b,c,d,e,f,g,h,i){var j,k,l;return l="recommend",k=null,j=b(""+h.href+"/contribute_requests"),a.selectedPost=null,a.removeSelectedPost=function(){return a.selectedPost=null},a.submit=function(){return j.save(a.selectedPost,function(){return a.showSuccess=!0,a.selectedPost=null})},a.suggestOptions={source:"/api/me/posts?limit=5&except_column="+h.slug,handleInput:function(a){return l=a.target.value?"search":"recommend"},handleBlur:function(a){},handleFocus:function(a){return this.renderRows(k)},select:function(b){return a.selectedPost=b,l="recommend",""},render:function(a,b,d){var e,f;return f=c('<div class="row">\n  <span class="name">{{title}}</span>\n</div>'),e="","recommend"===l&&(e+='<p class="row-title">最近文章</p>'),e+=d.map(function(a){return f(a.data)}).join(""),b.innerHTML=e}},g.get({limit:5,except_column:h.slug},function(b,c){return a.myPostsCount=c||b.length,a.myPosts=k=b}).$promise["catch"](function(){return e.close()})}])}.call(this),function(){app.factory("recommendService",["dialog",function(a){return function(b,c){return a.fromUrl("/scripts/recommend/dialog-recommend.html",{controller:"RecommendCtrl",scope:b,resolve:{post:c}}).then(function(a){return a.open()})}}]),app.controller("RecommendCtrl",["$scope","post","dialog",function(a,b,c){return a.title=b.title,a.submit=function(){return b.recommend(a.reason).$promise.then(function(){return c.message("已推荐，符合要求的文章会收录到日报")})["catch"](function(a){var b;return b=a.data,c.message(b&&b.message||"推荐失败，请重试")})}}])}.call(this),function(){app.controller("TipjarActivateDialogCtrl",["$scope","$location","$route","Post",function(a,b,c,d){return a.defaultTagLine="真诚赞赏，手留余香",a.submit=function(){var e;return a.post.tipjarTagLine||(a.post.tipjarTagLine=a.defaultTagLine),e={tipjarTagLine:a.post.tipjarTagLine},"activated"!==a.post.tipjarState&&(e.tipjarState="activated"),d.patch({postSlug:a.post.slug},e,function(){return-1===b.hash().indexOf("tipjar")?b.hash("tipjar"):c.reload(),a.post.tipjarState="activated"})}}]).controller("TipjarBindDialogCtrl",["$scope","$window","tipjarFollow",function(a,b,c){return a.bind=function(){return b.open("https://www.zhihu.com/settings/account"),c.open(a)}}]).controller("TipjarFollowDialogCtrl",["$scope","tipjarActivate","tipjarService","dlg",function(a,b,c,d){return a.followed=function(e){return e.stopPropagation(),e.preventDefault(),c.getState(a.post.slug).then(function(c){var e;return e=c.data.state,"needBindWechat"===e?a.errMsg="请先绑定微信":"needFollowOfficial"===e?a.errMsg="请先扫码关注「知乎」微信公众帐号":(d.close(),a.errMsg="",a.post.tipjarState=e,b.open(a))})}}]).factory("tipjarFollow",["dialog",function(a){var b;return b=null,{open:function(c){return this.close(),a.fromUrl("/scripts/tipjar/dialog-follow.html",{scope:c,controller:"TipjarFollowDialogCtrl"}).then(function(a){return b=a,a.open()})},close:function(){return b?b.close():void 0}}}]).factory("tipjarActivate",["dialog",function(a){var b;return b=null,{open:function(c){return this.close(),a.fromUrl("/scripts/tipjar/dialog-active.html",{scope:c,controller:"TipjarActivateDialogCtrl"}).then(function(a){return b=a,a.setButtonDefault("yes"),a.open()})},close:function(){return b?b.close():void 0}}}]).factory("tipjarTip",["dialog","mediator",function(a,b){var c;return c=null,{open:function(d){return this.close(),a.fromUrl("/scripts/tipjar/dialog-tip.html",{scope:d,controller:"TipjarTipDialogCtrl"}).then(function(a){return c=a,a.open(),a.on("afterhide",function(){return b.publish("tipDialog:close")}),angular.element(a.getDialogElement()).css("top",130)})},close:function(){return c?c.close():void 0}}}])}.call(this),function(){app.controller("TipjarTipDialogCtrl",["$scope","$location","$timeout","$interval","$sce","element","tipjarService","siteConfig","me","mediator","snsShare","ga","pay","wx",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o,p,q,r,s,t;return a.amountList=[2,5,10,50,100,200],a.tip="",p=null,q=!1,j.subscribe("tipDialog:close",function(){return q=!0,p?(p.dispose(),p=null):void 0}),a.$on("numcode:change",function(b,c){return a.payLoading=!0,a.payError="",p.payWithBalance(c)}),a.handleSendSMS=function(){var b;return a.sendingSMS=60,p.resendSMSCode(),b=d(function(){return a.sendingSMS?a.sendingSMS--:d.cancel(b)},1e3)},a.handleWechatPay=function(){var b;return a.currentPaymentMethod="wechat",b=window.zhihu.pay.Trade,a.wechatLoading=!0,p.on(b.EVENT_PAY_INITED,function(b,d){return"wechat"===b?(a.payLoading=!1,a.wechatLoading=!1,c(function(){return new QRCode(document.getElementById("PayQRCode"),{text:d.codeUrl,width:115,height:115})}),a.$apply()):void 0}),p.on(b.EVENT_NEED_WECHAT_CODE,function(){return window.localStorage.setItem(h.tipjarOpenKey,1),n.doOauth()}),p.on(b.EVENT_PAY_FAIL,function(b){return window.alert(b.message||"未知错误，请重试"),a.paying=!1,a.payLoading=!1,a.$apply()}),p.on(b.EVENT_PAY_CANCEL,function(){return a.paying=!1,a.payLoading=!1,a.$apply()}),p.on(b.EVENT_PAY_SUCCESS,function(){return r(),a.$apply()}),p.initWechatPay(a.wxCode)},a.handleBalancePay=function(){var b;return b=window.zhihu.pay.Trade,p.on(b.EVENT_PAY_INITED,function(b,c){return"balance"===b?(a.currentPaymentMethod="balance",a.$apply()):void 0}),p.on(b.EVENT_PAY_FAIL,function(b){return a.payError=b.message,a.payLoading=!1,s(),a.$apply()}),p.on(b.EVENT_NEED_SMS,function(b){return a.currentPaymentMethod="sms",a.smsDescription=b.message||"支付金额超过 500 元，需要验证手机",a.payLoading=!1,a.$apply()}),p.on(b.EVENT_PAY_SUCCESS,function(){return r(),a.$apply()}),p.initBalancePay()},s=function(){return"balance"===a.currentPaymentMethod?a.$broadcast("reset:code",!0):void 0},a.handleSMSPay=function(a){return p.payWithBalance(a)},o=function(b){return a.amount=b,a.paying=!0,a.payLoading=!0,a.envType=n.isInWX()?"wechat":"normal",g.create(b,a.post.slug,a.envType,a).then(function(b){return m.getTrade(b.tradeNumber).then(function(b){var c;return q?void 0:(p=b.trade,c=b.payments,c.balance&&0!==c.balance.amount?(a.payLoading=!1,a.balance=c.balance,a.currentPaymentMethod="both"):a.handleWechatPay())})})},t=function(){var c,d;return d={title:"我在知乎赞赏了："+a.post.title,url:b.absUrl()},a.post.snapshotUrl&&(d.pic=a.post.snapshotUrl),c=a.post.author.sinaName?"@"+a.post.author.sinaName:a.post.author.name,k.share("sina",c,d,!0)},a.shareItems=[{label:"新浪微博",icon:"icon-ic_share_sina",className:"menu-item-sina",action:function(){return t()}},{label:"微信扫一扫",icon:"icon-ic_share_wechat",action:function(){},html:e.trustAsHtml('<div class="ShareQRCode"></div>'),className:"menu-item-wechat"}],r=function(){return a.showSuccess=!0,a.addTipjaror(i.authed()?i:{slug:0}),"wechat"===a.envType?void a.$emit("wechatpay:success"):(a.post.author.sinaName||k.getSinaAuthorName(a.post.author.slug).then(function(b){return a.post.author.sinaName=b}),c(function(){var a;return a=b.absUrl(),a=a+(-1===a.indexOf("#")?"#":"&")+"tjshare",new QRCode(f.find(".ShareQRCode")[0],{text:a,width:100,height:100})}))},a.selectAmount=function(b,c){return o(a.amountList[c]),""},a.showCustom=function(){return a.customShow=!0,c(function(){return f.find('input[name="tip"]').focus()})},a.handleDoTip=function(a,b){return a.preventDefault(),o(b)},f.on("click",".menu-item-sina",function(){return l.track("tipjar","click_tipjar_share_weibo","planB")}).on("mouseenter",".menu-item-wechat",function(){return l.track("tipjar","hover_tipjar_share_weixin","planB")})}])}.call(this),function(){app.factory("tipjarService",["$resource","$route","$q","$timeout","eagerHttp","wx",function(a,b,c,d,e,f){var g,h;return g=c.defer(),h=function(b){var c;return c=a("/api/posts/:postSlug/tipjar_wallet",{postSlug:"@postSlug"},{create:{method:"POST",timeout:b}})},{create:function(a,b,d,e){var f;return g.resolve(),g=c.defer(),f=c.defer(),h(g.promise).create({postSlug:b,amount:100*a,type:d},function(a){var c;return a.postSlug=b,c=null,f.resolve(a)},function(a){return f.reject(a)}),f.promise}}}])}.call(this),function(){app.directive("uiTipjar",["$q","$location","$timeout","$window","$anchorScroll","dialog","ga","pay",function(a,b,c,d,e,f,g,h){return{restrict:"AE",replace:!0,scope:!0,templateUrl:"/scripts/tipjar/tipjar.html",controller:["$scope","$http","$route","$timeout","$window","$location","$rootScope","Post","dialog","tipjarFollow","tipjarActivate","tipjarService","tipjarTip","openInApp","requireLogin","siteConfig","ga","wx",function(a,b,c,d,e,f,g,i,j,k,l,m,n,o,p,q,r,s){return a.activeTipjar=function(){return a.activeStateLoading=!0,h.init().then(function(b){return h.ensureUser().then(function(){return a.activeStateLoading=!1,l.open(a)},function(b,c){return a.activeStateLoading=!1,"needBindPhone"===b?j({title:"开启赞赏",cssClass:"confirm",content:"绑定手机后方可开启赞赏功能",buttons:{cancel:"取消",yes:"前往绑定"}},function(a){return"yes"===a?window.open("https://www.zhihu.com/settings/account"):void 0}).open():j.message(c.message||"未知错误")})})},a.viewAllTipjaror=function(){return r.track("tipjar","click_tipjar_people","planB"),a.fetchTipjarorsPending=!0,b.get(""+a.post.href+"/tipjarors").then(function(b){return a.fetchTipjarorsPending=!1,a.tipjarors=b.data})},a.addTipjaror=function(b){return a.tipjarors?a.tipjarors.unshift(b):a.post.lastestTipjarors.unshift(b),a.post.tipjarorCount++},a.editTipjar=function(){return l.open(a)},a.tip=function(){return r.track("tipjar","click_tipjar","planB"),s.isInWX()?(window.localStorage.setItem(q.tipjarOpenKey,1),void s.doOauth()):angular.element(e).width()<420&&!s.isInWX()?void o.openPost(a.post.slug):p(function(){return n.open(a)})()},a.$on("tipjar:enable",function(){return a.activeTipjar()}),a.$on("tipjar:disable",function(){return j.confirm(a,"关闭赞赏","关闭后，读者将无法赞赏这篇文章，确定要关闭吗？",function(){return a.post.tipjarState="inactivated",i.patch({postSlug:a.post.slug},{tipjarState:"inactivated"})})}),a.tipjarAmount=Math.floor(a.post.tipjarAmount/100),Number(window.localStorage.getItem(q.tipjarOpenKey))&&(n.open(a),window.localStorage.removeItem(q.tipjarOpenKey)),c.current.params.code?a.wxCode=c.current.params.code:void 0}],link:function(a,b,d){return g.track("tipjar","visit_page","planB"),c(function(){return e()})}}}]).directive("uiTipjarUser",function(){return{restrict:"AE",replace:!0,scope:!1,templateUrl:"/scripts/tipjar/tipjar-user.html"}})}.call(this),function(){app.factory("oauth",["$window","domainConfig",function(a,b){return{register:function(c){var d,e,f,g,h,i,j;return d="/oauth/account_callback",j={qq:""+b.qqOAuthUrl+"?next="+d,sina:""+b.sinaOAuthUrl+"?next="+d},h=navigator.userAgent,e=/Mobile/.test(h)&&/CriOS/.test(h),f=/MicroMessenger/.test(h),i=j[c],g=!(e||f),g?a.open(i,"oauth","top=200,left=400,width=600,height=380,directories=no,menubar=no,toolbar=no"):location.href=i+"&from="+encodeURIComponent(location.href)}}}])}.call(this),function(){app.factory("me",["$resource",function(a){var b;return b=a("/api/me/:action",{},{activate:{method:"PUT",params:{action:"activate"}}}),b.prototype.authed=function(){return!!this.name},b.prototype.refresh=function(){return this.$get()},b.prototype.activate=function(){return b.activate.apply(b,arguments)},b.get()}]),app.factory("myPost",["$resource",function(a){var b;return b=a("/api/me/posts"),{get:function(a,c){return null==c&&(c=function(){}),b.query(a,function(a,b){var d;return d=+b("X-Result-Count"),c?c(a,d):void 0})},search:function(a,c){return b.query({limit:c,keyword:a})}}}]),app.factory("runIfSignedIn",["me",function(a){return function(b){return function(){return a.authed()?b.apply(this,arguments):void 0}}}]),app.factory("requireLogin",["$rootScope","me",function(a,b){return function(c){return function(){return b.authed()?c.apply(this,arguments):a.$broadcast("event:loginRequired")}}}]),app.factory("requireActivate",["$rootScope","me","requireLogin",function(a,b,c){return function(d){return c(function(){return b.activated?d.apply(this,arguments):a.$broadcast("event:activateRequired")})}}]),app.factory("requireNotMuted",["$rootScope","me","requireLogin",function(a,b,c){return function(c){return function(){return b.muted?a.$broadcast("event:notMutedRequired"):c.apply(this,arguments)}}}])}.call(this),function(){app.factory("DM",["$resource","$http","eagerHttp","runIfSignedIn",function(a,b,c,d){var e;return e=a("/api/message/:slug",{slug:"@slug"},{create:{method:"POST"}})}])}.call(this),function(){app.factory("Post",["$resource","$http","eagerHttp","requireActivate","runIfSignedIn","zap",function(a,b,c,d,e,f){var g;return g=a("/api/posts/:postSlug/:action",{postSlug:"@slug"},{patch:{method:"PATCH"},recommend:{method:"PUT",params:{action:"recommend"}}}),g.prototype.remove=function(a,b){return g.remove({postSlug:this.slug},a,b)},g.prototype.setRating=function(a){var b;return b=this.rating,b!==a?(this.rating=a,"like"===a?this.likesCount+=1:"like"===b?this.likesCount-=1:void 0):void 0},g.prototype.toggleRate=d(function(a){var b,c,d=this;return b=this.rating,a=b===a?"none":a,c=$(".entry-controls .votes a"),"like"===a?f.trackEvent(c,{action:"Upvote",element:"Button"}):"none"===a&&f.trackEvent(c,{action:"UnUpvote",element:"Button"}),this.setRating(a),this.rate(a).then(null,function(){return d.setRating(b)})}),g.prototype.toggleLike=function(a){return this.toggleRate("like")},g.prototype.toggleDislike=function(a){return this.toggleRate("dislike")},g.prototype.rate=c(function(a){return{method:"PUT",url:""+this.href+"/rating",data:{value:a}}}),g.prototype.recommend=function(a){return g.recommend({columnSlug:this.column.slug,postSlug:this.slug},{reason:a})},g.prototype.getTipjarStatus=function(a){return g.get({postSlug:this.slug,fields:"tipjarState"},a)},g.prototype.read=e(function(){return b({url:"/lastread/touch",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param({items:JSON.stringify([["post",String(this.slug),"read"]])})})}),g}])}.call(this),function(){app.factory("Draft",["$resource","$http",function(a,b){var c;return c=a("/api/drafts/:postSlug/:action",{postSlug:"@id"},{get:{url:"/api/posts/:postSlug/draft"},create:{method:"POST"},patch:{method:"PATCH"},publish:{method:"PUT",params:{action:"publish"}}}),c.doPublish=function(a){return"published"===a.state?b.put("/api/drafts/"+(a.id||a.slug)+"/publish",a).then(function(a){return a.data}):a.$publish()},c}])}.call(this),function(){app.factory("Column",["$resource","$http","eagerHttp","runIfSignedIn","requireActivate",function(a,b,c,d,e){var f;return f=a("/api/columns/:columnSlug/:action",{columnSlug:"@slug"},{create:{method:"POST"},patch:{method:"PATCH"},follow:{method:"PUT",params:{action:"follow"},interceptor:{response:function(){}}},unfollow:{method:"DELETE",params:{action:"follow"}},authors:{method:"GET",isArray:!0,params:{action:"authors"}},changeAuthor:{method:"PATCH",url:"/api/columns/:columnSlug/authors/:author"},deleteAuthor:{method:"DELETE",url:"/api/columns/:columnSlug/authors/:author"},pin:{method:"PUT",url:"/api/columns/:columnSlug/pins/posts/:post"},unpin:{method:"DELETE",url:"/api/columns/:columnSlug/pins/posts/:post"},uninclude:{method:"DELETE",url:"/api/columns/:columnSlug/includes/posts/:post"},rejectContribute:{method:"DELETE",url:"api/columns/:columnSlug/contribute_requests/:cid"},removePost:{method:"DELETE",url:"/api/posts/:post"}}),f.prototype.queryAuthors=function(){return f.authors({columnSlug:this.slug})},f.prototype.setFollowing=function(a){return this.following=a,this.followersCount+=a?1:-1},f.prototype.toggleFollow=e(function(){var a,b=this;return a=!this.following,this.setFollowing(a),this.follow(a).then(null,function(){return b.setFollowing(!a)})}),f.prototype.follow=c(function(a){return{method:a&&"PUT"||"DELETE",url:""+this.href+"/follow"}}),f.prototype.read=d(function(){return b({url:"/lastread/touch",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param({items:JSON.stringify([["column",String(this.slug),"read"]])})})}),f}])}.call(this),function(){app.factory("Image",["$http",function(a){var b,c;return b=function(a){var b;return(b=a.match(/^http[s]?:\/\/[\w\d\.]+\/(.+?)(_\w+)?\.\w+$/))?b[1]:""},c=function(a){return a.replace(/^(.+)?_\w+(\..+)$/,"$1$2")},{getInfo:function(b){return b=c(b),b+="?imageInfo","localhost"===location.hostname&&(b="/api"+b),a({method:"GET",url:b,responseType:"json"})},canTitleImageFullScreen:function(a){return a.width>=1366&&a.height>=550},getOriginUrlFromUrl:c}}])}.call(this),function(){app.factory("UserColumn",["$resource","$http","eagerHttp","runIfSignedIn",function(a,b,c,d){var e;return e=a("/api/u/:columnSlug/:action",{columnSlug:"@slug"},{create:{method:"POST"},patch:{method:"PATCH"},follow:{method:"PUT",params:{action:"follow"}},unfollow:{method:"DELETE",params:{action:"follow"}},authors:{method:"GET",isArray:!0,params:{action:"authors"}}}),e.prototype.queryAuthors=function(){return e.authors({columnSlug:this.slug})},e.prototype.setFollowing=function(a){return this.following=a,this.followersCount+=a?1:-1},e.prototype.toggleFollow=function(){var a,b=this;return a=!this.following,this.setFollowing(a),this.follow(a).then(null,function(){return b.setFollowing(!a)})},e.prototype.follow=c(function(a){return{method:a&&"PUT"||"DELETE",url:""+this.href+"/follow"}}),e.prototype.read=d(function(){return b.put(""+this.href+"/read")}),e}])}.call(this),function(){app.factory("HomeRecommend",["Recommendation","$filter","parseLinkHeader",function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;return f=Math.floor(100*Math.random()),e={recommendColumn:8,newestColumn:8,
recommendPost:6},i={recommendColumn:1,newestColumn:1,recommendPost:1},g={recommendColumn:[],newestColumn:[],recommendPost:[]},h={recommendColumn:[],newestColumn:[],recommendPost:[]},k={recommendColumn:0,newestColumn:0,recommendPost:0},q={recommendColumn:"columns",newestColumn:"new-columns",recommendPost:"posts"},d={recommendPost:!1,recommendColumn:!1},r="",o={recommendColumn:function(a){return a.map(function(a){return"large"===r||"middle"===r?a.displayDescription=b("truncateHtml")(a.description,42):a.displayDescription=b("truncateHtml")(a.description,36),a})},newestColumn:function(a){return this.recommendColumn(a)},recommendPost:function(a){return a.map(function(a){var c;return a.displayTitle=a.title,a.displayAuthorName=a.author.name,a.displayColumnName=(null!=(c=a.column)?c.name:void 0)||"",a.titleImage=b("imgSize")(a.titleImage,"b"),"large"===r?(a.displayTitle=b("truncateHtml")(a.title,56),a.displaySummary=b("truncateHtml")(a.summary,a.titleImage?80:170)):"middle"===r?(a.displayTitle=b("truncateHtml")(a.title,38),a.displaySummary=b("truncateHtml")(a.summary,a.titleImage?28:170)):a.displaySummary=b("truncateHtml")(a.summary,36),a})}},n=function(){var a,b,c;c=[];for(b in h)a=h[b],c.push(o[b](a));return c},j=function(b,d){var h;return k[b]=1,h=2*e[b],a.query({type:q[b],limit:h,offset:g[b].length,seed:f},function(a,e){var f;return f=c(e("link")),k[b]=0,a.length<h&&(k[b]=-1),g[b]=g[b].concat(a),d&&d()})},m=function(a){return i[a]=1,h[a].push.apply(h[a],o[a](g[a].slice(0,e[a])))},l=function(a){var b,c;if(h[a].length=0,2!==k[a]&&2!==k[a]){if(1===k[a]&&(k[a]=2),b=i[a]+1,c=g[a].slice((b-1)*e[a],b*e[a]),!c.length)return-1===k[a]?void m(a):void j(a,function(){return l(a)});if(c.length===e[a]?(h[a].push.apply(h[a],o[a](c)),i[a]=b):m(a),-1!==k[a])return b++,g[a].slice((b-1)*e[a]).length?void 0:j(a,function(){return 2===k[a]?l(a):void 0})}},p=function(){return"large"===r?(e.recommendColumn=e.newestColumn=8,e.recommendPost=6):"middle"===r?(e.recommendColumn=e.newestColumn=6,e.recommendPost=4):e.recommendColumn=e.newestColumn=e.recommendPost=4},{recommendColumns:h.recommendColumn,newestColumns:h.newestColumn,recommendPosts:h.recommendPost,nextRecommendPost:l.bind(null,"recommendPost"),nextRecommendColumn:l.bind(null,"recommendColumn"),nextNewestColumn:l.bind(null,"newestColumn"),updateWinType:function(a){return r=a,p(),n()},init:function(){return Object.keys(d).forEach(function(a){return d[a]?void 0:j(a,function(){return d[a]=!0,m(a)})})}}}])}.call(this),function(){app.factory("stacktraceService",function(){return{print:printStackTrace}}),app.provider("$exceptionHandler",{$get:["errorLogService",function(a){return a}]}),app.factory("errorLogService",["$log","$window","stacktraceService",function(a,b,c){var d,e;return d=function(a,b){var c;return c=null,function(){return clearTimeout(c),c=setTimeout(b.apply.bind(b,this,arguments),a)}},e=d(300,function(a,b){return $.ajax({method:"POST",url:"/api/client/errors",contentType:"application/json",data:angular.toJson(b)})}),function(d,f){var g,h,i;a.error.apply(a,arguments);try{return g=d.toString(),i=c.print({e:d}),e("/api/client/errors",{userAgent:b.navigator.userAgent,errorUrl:b.location.href,errorMessage:g,stackTrace:i,cause:f||""})}catch(j){return h=j,a.warn("Error logging failed"),a.log(h)}}}])}.call(this),function(){app.factory("Recommendation",["$resource",function(a){return a("/api/recommendations/:type")}])}.call(this),function(){app.service("sharedData",["$resource",function(a){var b;return b={},{set:function(a,c){return b[a]=c},get:function(a){return b[a]},remove:function(a){return delete b[a]}}}])}.call(this),function(){app.service("globalAlert",["$resource","$timeout",function(a,b){return{type:"info",message:"",set:function(a,c,d){var e=this;return null==d&&(d=300),b(function(){return e.setSync(a,c)},d)},setSync:function(a,b){this.message=a,this.type=null!=b?b:"info"},clear:function(){return this.message="",this.type=""}}}])}.call(this),function(){app.constant("parseLinkHeader",function(){var a,b;return b=/^<(.+)>$/,a=function(a){var c,d,e,f;return f=a.split(";"),e=f.shift(),b.test(e)&&(c=e.slice(1,-1)),d={},c&&(d.href=c,f.forEach(function(a){var b,c,e;return e=a.split("="),b=e[0],c=e[1],d[b]=c})),d},function(b){var c;return b?(c=b.split(","),c.reduce(function(b,c){var d;return d=a(c),d.rel&&d.href&&(b[d.rel]=d),b},{})):{}}}())}.call(this),function(){app.service("linkHeaderSource",["$http","parseLinkHeader",function(a,b){return{create:function(c,d,e){var f;return null==d&&(d=[]),f={url:c,error:!1,pending:!1,immediate:!0,completed:!1,onadd:function(a){return e?d.push.apply(d,a.map(function(a){return new e(a)})):d.push.apply(d,a)},onnext:function(){},fetch:function(){var c;return f.pending=!0,c=a.get(f.url),c["finally"](function(){return f.pending=!1}),c.success(function(a,c,d){var e,g;return Array.isArray(a)&&a.length&&f.onadd(a),e=d("X-Result-Count"),e&&(f.count=Number(e)),g=b(d("link")),g.next?f.url=g.next.href:f.completed=!0,f.onnext()}).error(function(){return f.error=!0,f.completed=!0})}}}}}])}.call(this),function(){app.service("snsShare",["$window","$http","$q",function(a,b,c){var d,e;return e=function(b){return Object.keys(b).map(function(c){return c+"="+a.encodeURIComponent(b[c])}).join("&")},d={sina:{from:"分享自 @知乎 专栏",url:"http://service.weibo.com/share/share.php?",extra:{appkey:3063806388}},qq:{from:"分享自 @izhihu 专栏",url:"http://v.t.qq.com/share/share.php?",extra:{appkey:801128020}},douban:{from:"分享自知乎专栏",url:"http://www.douban.com/recommend/?"},twitter:{from:"分享自 @wenzhihu 专栏",url:"https://twitter.com/intent/tweet?"},dudu:{url:"https://dudu.zhihu.com/post?"}},{share:function(b,c,f,g,h){var i,j;return null==g&&(g=!0),i=d[b],i&&f?(f=angular.extend({},f,i.extra),g&&(f.title+=c?"（"+i.from+" · 作者："+c+"）":"（"+i.from+"）"),"twitter"===b&&(f.text=f.title,delete f.title),"dudu"===b&&(f.utm_source="zhuanlan-article_share",f.utm_medium="button",f.utm_campaign="post",delete f.title),j=e(f),h?location.href=i.url+j:a.open(i.url+j),""):void 0},getSinaAuthorName:function(a){var d;return d=c.defer(),b.get("/api/users/"+a+"/connections").then(function(a){var b;return d.resolve((null!=(b=a.data.sina)?b.name:void 0)||"")},function(){return d.resolve("")}),d.promise}}}])}.call(this),function(){var a=[].slice;app.service("docTitle",["$window","mediator","siteName",function(b,c,d){return{push:function(){var c,e;return e=1<=arguments.length?a.call(arguments,0):[],c=e.join(" - "),c=c&&-1!==c[c.length-1].indexOf("$")?c.slice(0,-1):[c,d].join(" - "),b.document.title=c},get:function(){return b.document.title.split(" - ")[0]},hide:function(){return c.publish("navbar:hideTitle")},show:function(){return c.publish("navbar:showTitle")},setNavbarTitle:function(a){return c.publish("navbar:setTitle",a)},setStatus:function(a){return c.publish("navbar:setStatus",a)},setExtraStatus:function(a){return c.publish("navbar:setExtraStatus",a)}}}])}.call(this),function(){app.service("winType",["$window",function(a){return{get:function(){var b,c;return b=angular.element(a),c="large",b.width()<660?c="small":b.width()<1020&&(c="middle"),c}}}])}.call(this),function(){app.service("authResolver",["$q","$location","domainConfig","me",function(a,b,c,d){var e;return e=function(){return location.replace(c.loginUrl())},this.resolve=function(){var b;return b=a.defer(),b.promise.then(null,e),d.$promise.then(function(){return d.slug?b.resolve(d):b.reject()},b.reject),b.promise}}])}.call(this),function(){app.service("viewPostResolver",["$q","$location","$http","domainConfig","me",function(a,b,c,d,e){var f,g;return g=function(){return b.path("/404").replace()},f=function(a,b){return b.author?a.slug===b.author.slug:!0},this.resolve=function(c,d){var g;return g=a.defer(),e.$promise["finally"](function(){var a;return"draft"!==d||f(e,c)?"post"!==d||!f(e,c)||"draft"!==(a=c.state)&&"reviewing"!==a?(c.column||"published"!==c.state||(c.column={slug:e.slug,url:"/u/"+e.slug,api:"/api/columns/"+e.slug,name:""+e.name+"的文章",type:"user"}),g.resolve(c)):b.path("/p/"+c.slug+"/edit").replace():b.path("/p/"+(c.slug||c.id)).replace()}),g.promise}}])}.call(this),function(){app.service("columnResolver",["$q","$route","$location","$rootScope","Column","me","UserColumn","renderServerError",function(a,b,c,d,e,f,g,h){return d.$on("$routeChangeStart",function(a,b){return b.params.columnSlug&&b.params.userColumnSlug?void 0:d.column=null}),this.resolve=function(i,j,k){var l,m,n,o;return n=a.defer(),l=(null!=i?i.slug:void 0)||b.current.params.columnSlug||b.current.params.userColumnSlug,l||"published"===j.state||n.resolve(null),o=b.current.params.userColumnSlug?g:e,"user"===(null!=i?i.type:void 0)&&(o=g),d.column&&d.column.slug===l?n.resolve(d.column):o===g?f.$promise["finally"](function(){return n.resolve({url:"/u/"+(j.author.slug||f.slug),name:""+(j.author.name||f.name)+"的文章",avatar:f.avatar,type:"user"})}):(m={columnSlug:l},"simple"===k&&(m.fields="name,url,href,following,avatar,canManage,slug,creator(slug)"),d.column=o.get(m,n.resolve,function(a){switch(n.reject(a),a.status){case 404:return c.path("/404").replace();case 500:return h()}})),n.promise}}])}.call(this),function(){app.service("postResolver",["$q","$route","$location","Post","renderServerError","me",function(a,b,c,d,e,f){return this.resolve=function(){var c,e;return c=a.defer(),e=b.current.params,d.get(e,function(a){return c.resolve(a)},function(a){return c.reject(a)}),c.promise}}])}.call(this),function(){app.factory("urlParser",function(){var a,b,c,d,e;return a=["protocol","host","hostname","port","pathname","search","hash","href"],b=/^(http:|https:|\/\/|\/)/,c=/^(http:|https:)/,e=function(d,e){var f;return null==e&&(e=!0),d&&!(e&&c||b).test(d)?{}:(f=document.createElement("a"),f.href=d,a.reduce(function(a,b){return a[b]=f[b],a},{}))},d=function(a){var b,c;return b=e(a),"http:"===(c=b.protocol)||"https:"===c},{parse:e,isUrl:d}})}.call(this),function(){app.factory("eagerHttp",["$http","$q",function(a,b){return function(c){var d;return d=null,function(){var e;return null!=d&&d.resolve(),d=b.defer(),e=c.apply(this,arguments),a(angular.extend(e,{timeout:d.promise}))["finally"](d.reject)}}}])}.call(this),function(){var a=[].slice;app.factory("mediator",["$rootScope",function(b){var c;return c=function(c,d){return b.$on(c,function(){var b,c;return b=arguments[0],c=2<=arguments.length?a.call(arguments,1):[],d.apply(b,c)})},{publish:function(a,c){return b.$emit(a,c).returnValue},subscribe:function(a,b){return Array.isArray(a)||(a=[a]),a.forEach(function(a){return c(a,b)})}}}])}.call(this),function(){app.factory("renderServerError",["$compile","$http","$templateCache",function(a,b,c){var d,e,f,g,h;return f=angular.element("[ng-view]"),g=f.scope(),e="/views/500.html",d=function(){return f.children().each(function(){var a;return a=angular.element(this).scope().$destroy()}),f.empty()},h=function(h){return b.get(e,{cache:c}).success(function(b){var c,e;return d(),e=g.$new(),e.message=h,c=angular.element(b),f.append(a(c)(e))}),!0}}])}.call(this),function(){app.service("preloadImage",["$q",function(a){return function(b){var c,d;return c=a.defer(),d=new Image,d.url=b,d.complete?c.resolve():(d.onload=c.resolve,d.onerror=c.reject),c.promise}}])}.call(this),function(){app.factory("preventUnload",["$window",function(a){return function(b,c,d){return a.onbeforeunload=function(){return d()&&c?c:void 0},b.$on("$destroy",function(b){return a.onbeforeunload=null}),b.$on("$locationChangeStart",function(b){return d()&&!a.confirm(""+c+"，确定离开此页？")?b.preventDefault():void 0})}}])}.call(this),function(){app.service("followButton",["$compile",function(a){var b;return b=a('<button ui-follow-button class="btn btn-sm " ng-click="column.toggleFollow()" ng-model="column.following"></button>'),{get:function(a){return b(a)}}}])}.call(this),function(){app.factory("pay",["$q","$interval","getScript",function(a,b,c){var d,e,f,g,h,i,j;return d="https://pay.zhihu.com/api/js?callback=",e=11,j=!1,g=!1,h=function(){var b,e;return e=a.defer(),g?e.promise:(g=!0,b="PayCallback_"+ +new Date,window[b]=function(){return j=!0,g=!1,e.resolve()},c(""+d+b),e.promise)},i=function(){var b;return b=a.defer(),j?(b.resolve(),b.promise):(h().then(b.resolve),b.promise)},f=function(){var b;return b=a.defer(),i().then(function(){var a,c;return a=window.zhihu.pay.User,a.reset(),c=a.getInstance(),c.on("error",function(a,c){return b.reject(a,c)}),c.initAuthStatus(function(){return b.resolve()})}),b.promise},{init:i,ensureUser:f,SERVICE_ID:e,getTrade:function(b){var c;return c=a.defer(),i().then(function(){var a;return a=new window.zhihu.pay.Trade(b,e),a.getPaymentsList(function(b){return c.resolve({trade:a,payments:b})})}),c.promise}}}])}.call(this),function(){app.factory("ga",["$rootScope",function(a){return{track:function(a,b,c,d,e){return c&&(c=""+c),d&&(d=parseInt(d,10)),window._gaq.push(["_trackEvent",a,b,c,d,!!e])},page:function(a){return a?window._gaq.push(["_trackPageview",a]):window._gaq.push(["_trackPageview"])}}}])}.call(this),function(){var a=this;app.factory("zap",["$http","$q","getScript",function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o;return o="//unpkg.zhimg.com/za-js-sdk@latest/dist/zap.js",j="zhuanlan.zhihu.com"!==location.hostname,l=j?"https://yuzhou2.aws.dev/api/v1":"https://zhihu-web-analytics.zhihu.com/api/v1",m="data-za-module",i="data-za-index",g=[],n=function(a){var b,c,d,e,f;return b=$(a),e=b.add(b.parents()).filter("["+m+"]").get().reverse(),f=[],c=[],d=e.forEach(function(a){var b,d,e;return(e=a.getAttribute(m))?(b=a.getAttribute(i),b||(b=$(a).siblings("["+i+"]").andSelf().index(a)),f.push({module:e,index:b}),d=angular.element(a).scope().moduleInfo||{},c.push(d)):void 0}),{path:f,module:c}},h=function(b){return function(){var c;if(!window.zap)return void g.push({fn:b,args:arguments});if(zap.SUPPORTED)try{return b.apply(a,arguments)}catch(d){if(c=d,window.console)return console.error(c)}}},f=function(){return window.localStorage&&window.ArrayBuffer&&window.Uint8Array&&window.DataView},k=function(){try{return"1"===localStorage.getItem("zap:logenabled")}catch(a){return!1}},e=h(function(a,b){return zap.config({apiHost:l,enableLog:j||k(),userId:a||null,memberHashId:b||null,product:"Zhihu"})}),{trackPageShow:h(function(a,b){return zap.trackPageShow(a,b)}),trackEvent:h(function(a,b,c){var d,e,f;return f=n(a),e=f.path,d=f.module,zap.trackEvent(angular.extend({},b,{path:e}),angular.extend({},c,{module:d}))}),init:function(b,c){return f()?d(o,!0).then(function(){var d,f;for(e(b,c),f=[];g.length;)d=g.shift(),f.push(d.fn.apply(a,d.args));return f}):void 0}}}])}.call(this),function(){app.filter("avatarUrl",["$window",function(a){var b,c,d;return c={25:"s",34:"is",50:"xs",68:"im",75:"m",100:"l",200:"xl"},b=function(a){return function(b){var d;return d=a.filter(function(a){return a>b})[0],d?c[d]:void 0}}(Object.keys(c)),d={small:"s",medium:"xs",large:"l","x-large":"xl"},function(e,f){var g,h;return null==f&&(f="l"),e?(angular.isObject(e)||(e={template:e}),angular.isNumber(f)?(f*=a.devicePixelRatio||1,f>200&&(f=200),(h=c[f]||(h=b(f)))&&(g=h)):angular.isString(f)&&(h=d[f])&&(g=h),e.template.replace("{id}",e.id||"").replace("{size}",g||f)):void 0}}])}.call(this),function(){app.filter("profileUrl",["domainConfig",function(a){return function(b){return""+a.wwwDomain+"/people/"+b}}])}.call(this),function(){app.filter("linkDomain",["urlParser",function(a){return function(b){var c;return c=a.parse(b).hostname,c?c.replace(/^www\./,""):b}}])}.call(this),function(){app.filter("prettyDate",function(){return function(a){var b;return a?(b=moment(a).fromNow(),"几秒前"===b?"刚刚":b):void 0}}),app.filter("formatDate",function(){return function(a,b){return a?moment(a).format(b||"llll"):void 0}})}.call(this),function(){app.filter("truncateHtml",function(){var a,b;return a={maxlen:200,ellipsis:"…",details:!1},b=angular.element("<div>"),function(c,d,e,f){var g,h,i,j,k,l,m,n;for(i={maxlen:d||a.maxlen,ellipsis:e||a.ellipsis,details:f||a.details},h=0,j="",k=b.text(c).text().replace(/<.+?>/g,""),m=0,n=k.length;n>m&&(g=k[m],h+=g.charCodeAt(0)<128?1:2,j+=g,!(h>=i.maxlen-1));m++);return l=!1,j!==k&&(l=!0,j=j.slice(0,j.length-1),j+=i.ellipsis),i.details?{truncated:l,output:j}:j}})}.call(this),function(){app.filter("wordlen",function(){return function(a){var b,c,d,e,f;for(null==a&&(a=""),c=0,f=a.split(""),d=0,e=f.length;e>d;d++)b=f[d],c+=b.charCodeAt(0)<128?1:2;return Math.ceil(c/2)}})}.call(this),function(){app.filter("imgSize",function(){return function(a,b){return null==a&&(a=""),null==b&&(b="r"),a.replace(/_\w+(\.\w+)$/,"_"+b+"$1")}})}.call(this),function(){app.directive("contenteditable",["$timeout",function(a){return{restrict:"A",require:"ngModel",link:function(b,c,d,e){var f,g,h,i,j,k,l,m;return j=d.holdertext||"",i="span.holdertext[holdertext]",f=angular.element("<span>").addClass("holdertext").attr("holdertext",1).attr("contenteditable",!1).text(j),h={el:f,visibleTags:"img, blockquote, pre, embed, video",empty:function(){var a;return a=c.text().length&&c.text()!==j,!(a||c.find(this.visibleTags).length)},check:function(){return this.empty()?this.show():this.hide()},exists:function(){var a;return a=c.find(i),a.length?(this.el=a.first(),a.slice(1).remove(),!0):void 0},show:function(){return this.exists()||(this.el.text()||this.el.text(j),c.prepend(this.el)),this.selectStart()},hide:function(){return this.exists()?this.el.remove():void 0},selectStart:function(){return document.activeElement===c[0]?this.hide():void 0}},f.on("click",function(){return h.selectStart()}),c.on("click focus blur",function(){return h.check()}),c.on("input",function(){return h.hide()}),g=angular.element("<div>"),l=function(){return g.html(c.html()),g.find(i).remove(),e.$setViewValue(g.html())},m=function(a){var c;return"$apply"===(c=b.$root.$$phase)||"$digest"===c?b.$eval(a):b.$apply(a)},k="oninput"in c[0]?"input":"keyup",c.on("blur "+k+" change",function(){return m(l)}),e.$render=function(){return c.html(e.$viewValue)},b.$watch(d.ngModel,function(a){return h.check()}),a(function(){return l(),h.check()})}}}])}.call(this),function(){app.directive("contentRequired",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){var e,f,g,h,i,j;return g=c.holdertext||"",i="img,embed",f=function(){return!!b.text().trim().length&&b.text()!==g},e=function(){return!!b.find(i).length},h=function(a){return!(f()||e())},j=function(a){return d.$setValidity("contentRequired",!h(a)),a},d.$formatters.push(j),d.$parsers.push(j)}}})}.call(this),function(){app.directive("uiPostItem",["$filter","winType",function(a,b){return{restrict:"AE",scope:{post:"=",type:"@",showSource:"=?",showRecommend:"=?",column:"=?"},templateUrl:"/views/post-item.html",replace:!0,link:function(a){},controller:["$scope","support",function(c,d){var e;if(c.post.titleImage&&d.backgroundSize&&(c.titleImageShow=!0),c.truncateMax=c.titleImageShow?114:178,c.showSource=c.showSource||!1,"narrow"===c.type&&c.titleImageShow&&(c.truncateMax=134),c.titleImageShow)switch(c.type){case"wide":c.itemClass="item-with-wide-img";break;case"narrow":c.itemClass="item-with-narrow-img";break;default:c.itemClass="item-with-title-img"}else c.itemClass="item-without-title-img";return c.showRecommend&&(c.itemClass+=" item-recommend"),e=!c.column||c.post.column&&c.post.column.slug===c.column.slug?"":c.column.slug,e&&(c.post.url=c.post.url+"?refer="+e),"small"===b.get()?c.post.titleImage=a("imgSize")(c.post.titleImage,"narrow"===c.type?"xl":"b"):c.post.titleImage=a("imgSize")(c.post.titleImage,"wide"===c.type?"r":"b")}]}}])}.call(this),function(){app.directive("uiCommentItem",["$filter","winType",function(a,b){return{restrict:"AE",scope:!1,templateUrl:"/views/comment-item.html",replace:!0}}])}.call(this),function(){app.directive("uiBlockTitle",["$timeout",function(a){return{restrict:"AE",replace:!0,transclude:!0,scope:!0,template:'<div class="block-title" ng-class="scope.help && block-title-help">\n  <span ng-transclude></span>\n  <div class="help" ng-if="help" ui-menu-button>\n    <span class="menu-button"><i class="icon-ic_help"></i></span>\n    <menu class="menu">\n      <div class="item">{{help}}</div>\n    </menu>\n  </div>\n</div>',link:function(a,b,c){return c.help&&(a.help=c.help),a.showHelp=!1}}}])}.call(this),function(){app.directive("uiColumnItem",["$rootScope",function(a){return{restrict:"AE",scope:{column:"=",contributeInfo:"=",index:"="},templateUrl:"/views/column-item.html",replace:!0,link:function(b,c,d){var e,f;return e=c.find(".cancel-contribute"),f=a.supportTouch,b.handleCancelContribute=function(){return f?void 0:b.$emit("contribute:remove",b.contributeInfo,b.index)},f?void 0:e.on("mouseenter mouseleave",function(a){return e.html("mouseenter"===a.type?"撤销投稿":"投稿中")})},controller:["$scope","support",function(a,b){}]}}])}.call(this),function(){app.directive("uiUserItem",function(){return{restrict:"AE",scope:{user:"=",column:"="},templateUrl:"/views/user-item.html",replace:!0,link:function(a){},controller:["$scope","support","me",function(a,b,c){return a.me=c}]}})}.call(this),function(){app.directive("uniqueColumnSlug",["Column","me","debounce",function(a,b,c){return{restrict:"A",require:"ngModel",link:function(d,e,f,g){var h,i,j;return h="uniqueColumnSlug",i=c(350,function(c){return a.get({columnSlug:c},function(a){return g.$setValidity(h,a.creator.slug===b.slug)},function(){return g.$setValidity(h,!0)})}),j=function(a){var b;return b=a&&Object.keys(g.$error).filter(function(a){return a!==h}).every(function(a){return g.$error[a]===!1}),b&&i(a),a},g.$formatters.push(j),g.$parsers.push(j)}}}]),app.directive("wordMax",["$filter",function(a){return{require:"ngModel",link:function(b,c,d,e){var f,g;return f=+d.wordMax||1/0,g=function(b){var c;return c=a("wordlen")(b),e.$setValidity("wordMax",f>=c),b},e.$parsers.push(g)}}}]),app.directive("wordMin",["$filter",function(a){return{require:"ngModel",link:function(b,c,d,e){var f,g;return f=+d.wordMin||0,g=function(b){var c;return c=a("wordlen")(b),e.$setValidity("wordMin",c>=f),b},e.$parsers.push(g)}}}]),app.directive("intMax",["$filter",function(a){return{require:"ngModel",link:function(a,b,c,d){var e,f;return e=+c.intMax||0,f=function(a){var b;return null==a&&(a=""),b=a.toString().replace(/[^0-9]+/g,"").replace(/^0+/,"")||"",d.$setValidity("intMax",e>=b||!a.length),a.length&&a.toString()!==b&&(d.$setViewValue(b),d.$render()),b},d.$parsers.push(f)}}}])}.call(this),function(){app.directive("uiColumnsSelector",function(){return{restrict:"A",replace:!0,scope:{title:"@",mode:"@",show:"=",href:"=",onselect:"&"},templateUrl:"/views/columns-selector.html",controller:["$scope","$element","$attrs","$location","$resource",function(a,b,c,d,e){return a.$watch("show",function(b){return b?a.columns=e(a.href).query():void 0}),a.close=function(){return a.show=!1},a.select=function(b,d){if(d){if(d.metaKey)return;d.preventDefault(),d.stopPropagation()}return c.onselect&&a.onselect({column:b})!==!1?a.close():void 0},a.create=function(){return a.close(),d.path("/create")}}]}})}.call(this),function(){app.directive("uiCtrlEnter",["$parse","$timeout",function(a,b){return function(b,c,d){var e,f;return e=a(d.uiCtrlEnter),f=function(a){var b;return b=13,a.keyCode===b&&(a.ctrlKey||a.metaKey)},c.on("keydown",function(a){return f(a)?(a.preventDefault(),b.$apply(function(){return e(b,{$event:a})})):void 0})}}])}.call(this),function(){app.directive("uiEditor",["$timeout","$http","$browser","globalAlert","domainConfig",function(a,b,c,d,e){return{restrict:"A",link:function(f,g,h){var i,j,k;return k={},k.headers={},k.headers[b.defaults.xsrfHeaderName]=c.cookies()[b.defaults.xsrfCookieName],k.onerror=function(a){return f.$apply(function(){return d.setSync(a,"error")})},"localhost"===location.hostname?(k.uploadUrl="/upload",k.formatResponse=function(a){return{src:a[0].url,width:100,height:200}}):k.uploadUrl=e.uploadUrl,j={toolbarId:h.editorToolbar,FastUpload:k,OneClickUpload:k},i=null,a(function(){return i=new zh.editor.Field(g.attr("id"),j),i.makeEditable(),i.on(["cvc","delayedchange"],function(){return g.trigger("change")})}),f.$on("$destroy",function(){return i.dispose()})}}}])}.call(this),function(){app.directive("uiScroller",["globalAlert",function(a){return{restrict:"A",link:function(a,b,c){var d;return d=new zh.ui.Scroller,d.decorate(b[0]),a.$on("$destroy",function(){return d.dispose()})}}}])}.call(this),function(){app.directive("uiFocusMe",["$timeout",function(a){return function(b,c,d){return b.$watch(d.uiFocusMe,function(b){return b?a(function(){return c[0].focus()},50):void 0})}}])}.call(this),function(){app.directive("uiEvents",["$parse","$timeout",function(a,b){return function(c,d,e){var f;return f=c.$eval(e.uiEvents),angular.forEach(f,function(e,f){return e=a(e),d.on(f,function(a){var d;return d=a.type.indexOf("focus")>-1,d?b(function(){return e(c,{$event:a})}):c.$apply(function(){return e(c,{$event:a})})})})}}])}.call(this),function(){app.directive("uiPostComments",function(){return{restrict:"A",replace:!0,scope:{href:"=commentsHref",addHref:"=?commentsAddHref",status:"=commentsStatus",state:"=?commentsState",expanded:"=commentsExpanded",postOwner:"=commentsPostOwner",placeholder:"@?commentsPlaceholder",needReview:"=?commentNeedReview",timeStyle:"@?",disableScraper:"=",locateCommentId:"=?"},controller:"PostCommentsCtrl",templateUrl:"/views/post-comments.html"}})}.call(this),function(){app.directive("uiTextareaAutogrow",["$timeout",function(a){return{restrict:"A",require:"?ngModel",link:function(b,c,d,e){var f;return f=function(){var a;return c.height(1),a=Math.max(c.prop("scrollHeight"),parseInt(c.css("min-height"),10)),c.css({height:a+2})},e?b.$watch(d.ngModel,f):c.bind("input change paste propertychange",function(){return a(f)})}}}])}.call(this),function(){app.directive("uiTime",["$timeout","$filter","$rootScope",function(a,b,c){return{restrict:"A",replace:!0,scope:{datetime:"@",timeStyle:"=?"},template:'<time ng-class="{short: timeStyle == \'short\'}" ui-hover-title="{{dataTitle}}">{{datetime | prettyDate}}</time>',link:function(a,c,d){return"short"===a.timeStyle?a.dataTitle=b("formatDate")(a.datetime,"MMMD日 HH:mm"):a.dataTitle=b("formatDate")(a.datetime)}}}])}.call(this),function(){app.directive("uiAlertbar",["$timeout","$window",function(a,b){return{restrict:"A",replace:!0,scope:{alert:"="},template:'<div class="ui-alertbar {{alert.type}}" ng-show="show">\n  <i class="icon-ic_prompt_done" ng-if="alert.type == \'info\'"></i>\n  <i class="icon-ic_prompt_error" ng-if="alert.type == \'error\'"></i>\n  {{alert.message}}\n</div>',link:function(c){var d;return d=angular.element(b),c.$watch("alert.message",function(b){return b?(c.show=!0,a(function(){return d.scroll()}),a(function(){return c.show=!1,a(function(){return c.alert.message=""},300)},3e3)):void 0})}}}])}.call(this),function(){app.directive("uiSticky",["$window",function(a){return{restrict:"A",link:function(b,c,d){var e,f,g,h,i,j,k,l;return l=angular.element(a),e=d.align||"bottom",i=+d.margin||0,k=angular.element(d.target),j=d.stickyClass||"sticky",f={top:function(){return l.scrollTop()+l.height()+i<k.offset().top},bottom:function(){return l.scrollTop()+i>k.offset().top+k.height()}},g=function(){return c.is(":visible")&&k.is(":visible")},h=function(){var a;return g()?(a=f[e](),c.toggleClass(j,a),c.toggleClass("un"+j,!a)):void 0},l.scroll(h),b.$on("$destroy",function(){return l.unbind("scroll",h)})}}}])}.call(this),function(){app.directive("uiLightbox",["$parse","$window","$compile","$rootScope",function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p;return e=27,f='<div\n ng-show="zoomed"\n ng-animate="{show: \'in\', hide: \'out\'}"\n class="lightbox-overlay"></div>',l=function(){var a,b,c;return a="width:50px;height:50px;overflow:scroll;position:absolute;top:-999em;",b=angular.element('<div style="'+a+'">'),b.appendTo(document.body),c=b[0].offsetWidth-b[0].clientWidth,b.remove(),c}(),m="img.zh-lightbox-thumb",n="data-thumb",k="data-original",o="data-rawwidth",g="data-rawheight",j="zoomed",h="lightbox-zoomin",i="lightbox-zoomin-active",l>0&&(p="html."+h+" body {padding-right: "+l+"px;}",angular.element("<style>").text(p).appendTo(document.body)),{restrict:"A",link:function(a,d,l){var n,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;return C=angular.element(b),p=angular.element(document.body),t=angular.element(document.documentElement),x=c(f)(a),x.appendTo(d),a.zoomed=!1,u=null,y=function(a){return{x:a.left+a.width/2,y:a.top+a.height/2}},z=function(a,b){return{x:b.x-a.x,y:b.y-a.y}},B=function(){return{left:0,top:0,width:C.width(),height:C.height()}},r=function(a){return z(y(a),y(B()))},q=function(a,b){var c,d,e,f,g,h;return e=20,f=B(),f={width:f.width-e,height:f.height-e},g=f.width/f.height,h=b.width,c=b.height,d=h/c,f.width>h&&f.height>c||(g>d?(c=f.height,h=c*d):(h=f.width,c=h/d)),h/a.width},v=function(b){return b.keyCode===e?a.$apply(E):void 0},w=function(b){return a.$apply(E)},n=function(){return p.on("keydown",v),x.on("click",w)},s=function(){return p.off("keydown",v),x.off("click",w)},A=function(){var a,b,c,d,e;return c=u[0].getBoundingClientRect(),a=r(c),b={width:c.width,height:c.height},e={width:+u.attr(o),height:+u.attr(g)},d=q(b,e),u.css({translate:[a.x,a.y],scale:d})},D=function(){return u.attr("src",u.attr(k)),u.addClass(j),t.addClass(h),A(),a.zoomed=!0,n(),u.trigger("lightbox:zoomin")},E=function(){return u.removeAttr("style"),t.addClass(i),u.one("transitionend",function(){return u.removeClass(j),t.removeClass(h),t.removeClass(i),u=null}),a.zoomed=!1,s(),u.trigger("lightbox:zoomout")},d.on("click",m,function(){return u=angular.element(this),a.$apply(function(){return a.zoomed?E():D()})}),a.$on("$destroy",function(){return a.zoomed&&E(),x.remove()})}}}])}.call(this),function(){app.directive("uiMenuButton",["$timeout","$parse","$rootScope",function(a,b,c){var d;return d=function(d,e,f){var g,h,i,j,k,l,m,n,o,p,q;return m=b(f.onbeforeopen),o=c.supportTouch,q=Number(f.toggleDelay)||150,o&&(q=0),d.$on("$locationChangeStart",function(){return n(!1)}),j=angular.element(document),k=function(){return d.$apply(function(){return n(!1)})},n=function(a){return a&&!d.open&&m(d),d.open=a,o?j[a&&"on"||"off"]("click",k):void 0},l=e.find("menu"),l.on("click",function(){return a(function(){return i(!1)})}),h=e.find(".menu-button"),h.on("keydown",function(a){var b,c,e;return c=32,b=13,(e=a.keyCode)===c||e===b?(a.preventDefault(),i(!d.open)):void 0}),l.add(h).on("focusout",function(b){var c;return c=function(a){return l[0].contains(a)?void 0:i(!1)},b.relatedTarget?c(b.relatedTarget):a(function(){return c(document.activeElement)})}),p=null,i=function(b,c){return b&&d.$eval(f.uiDisabled)&&!c?void 0:(a.cancel(p),p=a(function(){return n(b)},q))},o?h.on("click",function(a){return i(!d.open,!0)}):(h.add(l).on("mouseenter mouseleave",function(a){return i("mouseenter"===a.type)}),h.on("click",function(a){return i(!0,!0)})),g=function(){return l.children(".menu-item").attr("tabindex",0)},d.$watch(function(){return l.children().length},function(){return g()})},{restrict:"A",scope:!0,replace:!0,transclude:!0,template:"<div ng-transclude class=\"ui-menu-button\"\n  ng-class=\"{ true: 'open', false: 'close' }[open]\"></div>",controller:["$scope","$element","$attrs","$timeout",function(a,b,c,e){return e(function(){return d(a,b,c),b.addClass(c["class"])})}]}}])}.call(this),function(){app.directive("uiPopPanel",["$timeout","$parse","$rootScope","mediator",function(a,b,c,d){var e;return e=function(e,f,g){var h,i,j,k,l,m,n,o,p,q;return l=b(g.onbeforeopen),o=c.supportTouch,q=Number(g.toggleDelay)||150,o&&(q=0),e.$on("$locationChangeStart",function(){return n(!1)}),j=angular.element(document),k=function(a){return e.$apply(function(){return angular.element(a.target).closest(".ui-pop-button")[0]!==f[0]?n(!1):void 0})},n=function(a){return e.open=a,a&&l(e),j[a&&"on"||"off"]("click",k),g.uiOpen&&a&&e.$eval(g.uiOpen),g.uiClose&&!a&&e.$eval(g.uiClose),d.publish(a?"hovertitle:disable":"hovertitle:enable"),e.$emit("panelOpen",a)},m=f.find(".pop-panel"),h=f.find(".pop-button"),h.on("keydown",function(a){var b,c,d;return c=32,b=13,(d=a.keyCode)===c||d===b?(a.preventDefault(),i(!e.open)):void 0}),p=null,i=function(b){
return a.cancel(p),p=a(function(){return n(b)},q)},h.on("click",function(a){return h.attr("disabled")?void 0:i(!e.open)}),e.$eval(g.show)?i(!0):void 0},{restrict:"A",scope:!0,replace:!0,transclude:!0,template:"<div ng-transclude class=\"ui-pop-button\"\n  ng-class=\"{ true: 'open', false: 'close' }[open]\"></div>",controller:["$scope","$element","$attrs","$timeout",function(a,b,c,d){return d(function(){return e(a,b,c),b.addClass(c["class"])})}]}}])}.call(this),function(){app.directive("uiCleanPaste",["$timeout",function(a){return{restrict:"A",link:function(a,b){var c,d;return d={reservedClasses:["member_mention","video-link"]},c=new zh.ui.HtmlCleaner(b,d)}}}])}.call(this),function(){app.directive("uiMention",["domainConfig","$filter",function(a,b){return{restrict:"A",link:function(c,d,e){var f,g,h,i;return f=b("avatarUrl"),h={renderLink:function(b){return'<a href="http://'+a.wwwDomain+"/people/"+b.slug+'" data-hash="'+b.hash+'">@'+b.name+"</a>"}},i={method:"GET",source:"/api/autocomplete/users",renderRow:function(a){return'<img class="avatar" src="'+f(a.avatar,36)+'"><span class="name">'+a.name+"</span>"}},g=new zh.ui.MentionInput(d[0],h,i),c.$on("$destroy",function(){return g.destroy()})}}}])}.call(this),function(){app.directive("uiScraper",function(){return{restrict:"A",link:function(a,b,c){var d,e;return d=a.$eval(c.scraperOptions),e=new zh.ui.Scraper(b[0],d),a.$on("$destroy",function(){return e.destroy()})}}})}.call(this),function(){app.directive("uiTitleScraper",["$timeout","$http","$parse","urlParser",function(a,b,c,d){return{restrict:"A",require:"ngModel",link:function(e,f,g,h){var i,j,k,l,m,n,o,p,q,r;return m=c(g.onscrapesuccess),l=c(g.onscrapestart),k=c(g.onscrapeend),j=f[0],n=!1,o=function(a){return b.get("/api/scraper",{cache:!0,params:{url:a}})},r=function(a){return m(e,{link:a}),h.$setViewValue(a.title),h.$render(),f.trigger("change")},q=function(){return n=!0,l(e)},p=function(){return n=!1,k(e)},i=function(){var a;return n?void 0:(a=j.value.trim(),a&&d.isUrl(a)?(q(),o(a).then(function(a){return"link"===a.data.type&&r(a.data),p()},function(a){return p()})):void 0)},f.on("paste",function(b){return a(i)})}}}])}.call(this),function(){app.factory("infinite",["$window",function(a){return{distance:angular.element(a).height(),spinner:"<div ui-spinner></div>"}}]),app.directive("uiInfinite",["$window","$compile","$timeout","infinite","debounce",function(a,b,c,d,e){return{restrict:"A",link:function(f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u,v;return u="ui-infinite",m="immediate",r=f.$eval(h.source),t=f.$eval(h.spinner)||d.spinner,i=f.$eval(h.distance)||d.distance,v=angular.element(a),q=v,g.addClass(u),s=b(t)(f).appendTo(g),f.$watch(function(){return r.completed},function(a){return a?j():void 0}),n=function(){return r.pending?void 0:r.fetch().then(function(a){return!a.data||Array.isArray(a.data)&&!a.data.length?j():c(l,100),a})},j=function(){return s.remove(),v.off("resize",l),q.off("scroll",l)},o=function(){var a,b;return b=s[0].parentNode&&"none"!==s.css("display"),a=s[0].getBoundingClientRect().top,b&&a>0&&a-v.height()<=i},p=function(a,b){var c;return a.$root?(c=a.$root.$$phase,"$apply"===c||"$digest"===c?a.$eval(b):a.$apply(b)):void 0},l=e(200,function(){return r.pending?void 0:p(f,function(){return o()?n():void 0})}),k=function(){return r.immediate?(g.addClass(m),n().then(function(){return g.removeClass(m)})):void 0},f.$watch(h.source,function(){return r=f.$eval(h.source),k()}),v.on("resize",l),q.on("scroll",l),f.$on("$destroy",function(){return j()})}}}])}.call(this),function(){app.provider("pagination",function(){return{defaults:{pagination:'<div class="pagination" ng-if="pages" ng-show="total>1">\n  <button tabindex="0" class="prev btn btn-grey-nborder" ng-if="current != 1 && total != 1" ng-click="changeTo(current-1, $event)">上一页</button>\n  <button class="num btn btn-grey" ng-repeat="p in pages track by $index" ng-class="{current: p==current, disabled: p == \'...\',  \'btn-circle\': p==current, \'btn-circle-nborder\': p!=current}" ng-click="changeTo(p, $event)" tabindex="{{p === \'...\' ? \'-1\' : 0}}">{{p}}</button>\n  <button tabindex="0" class="next btn btn-grey-nborder" ng-if="current != total && total != 1" ng-click="changeTo(current+1, $event)">下一页</button>\n</div>',spinner:'<div class="ui-spinner-container"><div ui-spinner></div></div>',getPageNumbers:function(a,b){var c,d,e,f,g;return b?6>b?function(){e=[];for(var a=1;b>=1?b>=a:a>=b;b>=1?a++:a--)e.push(a);return e}.apply(this):a>=b-2?[1,"..."].concat(function(){f=[];for(var a=c=b-3;b>=c?b>=a:a>=b;b>=c?a++:a--)f.push(a);return f}.apply(this)):3>=a?[1,2,3,4].concat(["...",b]):[1,"..."].concat(function(){g=[];for(var b=d=a-1,c=a+1;c>=d?c>=b:b>=c;c>=d?b++:b--)g.push(b);return g}.apply(this).concat(["...",b])):null}},$get:function(){return this.defaults}}}),app.directive("uiPagination",["$window","$compile","$resource","pagination","$timeout",function(a,b,c,d,e){return{restrict:"A",scope:{url:"=",data:"=",limit:"@",index:"=?",extra:"="},controller:["$scope","$resource","pagination",function(a,b,c){return a.data||(a.data=[]),a.limit=a.limit||10,a.Source=b(a.url),a.extra=a.extra||{}}],link:function(f,g,h){var i,j,k,l,m,n,o,p,q,r,s;return r="ui-pagination",l=f.limit,s=angular.element(a),g.addClass(r),p=f.$eval(h.spinner)||d.spinner,o=b(p)(f).appendTo(g),m=b(d.pagination),f.current=1,f.total=1,q=-1,n=!1,f.changeTo=function(a,b){return+a?(f.current=+a,f.pages=d.getPageNumbers(f.current,f.total),o.show(),f.$emit("pagination:change"),b&&b.currentTarget&&b.currentTarget.blur(),f.Source.query({offset:(f.current-1)*l,limit:l},function(a){return j(a)})):void 0},i=function(a){return f.total=a&&a<f.extra.count?Math.ceil(f.extra.count/a):1,f.pages=d.getPageNumbers(f.current,f.total)},f.$watchCollection("extra",function(){return i(l)}),k=function(){var a;return o.show(),f.Source=c(f.url),f.data.length=0,f.current=1,a={limit:l},f.index>0&&(f.current=Math.floor(f.index/l)+1,a.offset=(f.current-1)*l),f.Source.query(a,function(a,b){return q=f.extra.count||+b("X-Result-Count"),!f.extra.count&&q&&(f.extra.count=q),i(l),n||(m(f).appendTo(g),n=!0),f.pages=d.getPageNumbers(f.current,f.total),j(a),f.$emit("pagination:firstInit")})},j=function(a){return o.hide(),f.data.length=0,f.data.push.apply(f.data,a),f.$emit("pagination:loaded",{current:f.current,total:f.total,count:f.extra.count})},f.$on("reload",function(){return k()}),f.$on("pagination:reloadcurrent",function(){return 0===f.data.length&&f.current>1?void f.changeTo(f.current-1):(o.show(),f.Source.query({offset:(f.current-1)*l,limit:l},function(a){return j(a)}))}),f.$on("pagination:loadlast",function(){return e(function(){return f.changeTo(f.total)})}),k()}}}])}.call(this),function(){app.directive("uiInView",["$parse","viewport",function(a,b){return{restrict:"A",link:function(c,d,e){var f;return f=a(e.oninviewonce),b.onInViewOnce(d,function(){return f(c)}),c.$on("$destroy",function(){return b.unlisten(d)})}}}])}.call(this),function(){app.directive("uiTabs",function(){return{restrict:"A",scope:{selectedIndex:"@"},replace:!0,transclude:!0,controller:"TabsCtrl",template:'<div class="ui-tabs">\n  <div class="tabs-nav clearfix">\n    <a href="#" class="tabs-anchor" ng-click="select(tab, $event)" ng-class="{ active: activeIndex == $index }" ng-repeat="tab in tabs">{{tab.title}}</a>\n  </div>\n  <div class="tabs-content" ng-transclude></div>\n</div>'}}),app.controller("TabsCtrl",["$scope","$location",function(a,b){var c,d,e=this;return d=a.tabs=[],c=function(b){return e.activeIndex=a.activeIndex=b},this.addTab=function(a,b){return d.push({title:a,anchor:b})},this.select=a.select=function(a,b){return null!=b&&b.preventDefault(),c(d.indexOf(a))},c(Number(a.selectedIndex)||0)}]),app.directive("uiTabPane",function(){return{require:"^uiTabs",restrict:"A",scope:{title:"@tabTitle",anchor:"@tabAnchor"},replace:!0,transclude:!0,template:'<div class="tabs-pane" ng-transclude ng-show="active()"></div>',link:function(a,b,c,d){return a.index=b.index(),a.active=function(){return d.activeIndex===a.index},d.addTab(a.title,a.anchor)}}})}.call(this),function(){app.directive("uiTagInput",["$timeout",function(a){var b;return b={minTags:1,maxTags:1/0,holdertext:"",suggestUrl:"/api/autocomplete/topics"},{restrict:"A",require:"ngModel",scope:{tags:"=ngModel",afterSelect:"&",customSuggestOptions:"=suggestOptions"},template:'<ul class="tags">\n  <li ng-repeat="tag in tags">\n    <span class="inner-wrapper">\n      <a class="tag-link" href="javascript:;" target="_blank" ng-bind-html="tag.name"></a>\n      <a class="remove-tag" href="javascript:;" ng-click="removeTag(tag)" title="移除"><i class="icon-ic_close"></i></a>\n    </span>\n  </li>\n</ul>\n<div class="input-container" ng-class="{\'mui-container-search\': tags.length < options.maxTags, \'disabled\': tags.length >= options.maxTags}">\n  <input ui-suggest suggest-options="suggestOptions" class="mui-input" ng-disabled="tags.length >= options.maxTags" placeholder="{{options.holdertext}}">\n</div>',controller:["$scope","$element","$attrs",function(c,d,e){var f;return c.tags||(c.tags=[]),c.options=angular.extend({},b),angular.forEach(e,function(a,d){return d in b?c.options[d]=a:void 0}),c.validities={},c.updateValidities=function(){return this.validities.minTags=this.tags.length>=c.options.minTags,this.validities.maxTags=this.tags.length<=c.options.maxTags},c.$watch("tags.length",function(){return c.updateValidities(),c.validate(),c.tags.length>=c.options.maxTags?d.find(".input-container input").blur():void 0}),c.removeTag=function(b){return a(function(){return c.tags.splice(c.tags.indexOf(b),1)})},c.suggestOptions={source:"/api/autocomplete/topics",filter:function(a){return a.filter(function(a){return c.tags.every(function(b){return b.id!==a.id})})},select:function(a){return c.tags.push(a),c.afterSelect&&c.afterSelect({tag:a}),""}},c.customSuggestOptions&&angular.forEach(c.customSuggestOptions,function(a,b){return c.suggestOptions[b]=a}),c.suggestOptions.render?(f=c.suggestOptions.render,c.suggestOptions.render=function(a,b,c){return f.apply(f,arguments),!c.length&&d.find(".input-container input").val()?angular.element(b).addClass("empty-list").html('<div class="row">没有找到该话题</div>'):angular.element(b).removeClass("empty-list")}):void 0}],link:function(a,b,c,d){return a.validate=function(a){return angular.forEach(this.validities,function(a,b){return d.$setValidity(b,a)})},d.$formatters.push(a.validate),d.$parsers.push(a.validate)}}}])}.call(this),function(){app.directive("uiSuggest",["$interpolate",function(a){return{scope:{options:"=suggestOptions"},link:function(b,c,d){var e,f,g;return f={rowTemplate:'<div class="row">\n  <img class="avatar" src="{{avatar | avatarUrl:25}}">\n  <span class="name">{{name}}</span>\n</div>',fadeDuration:100,source:d.source,renderTo:c.parent()[0],render:function(a,b,c){return b.innerHTML=c.map(function(a){return g(a.data)}).join("")}},angular.extend(f,b.options),g=a(f.rowTemplate),f.select&&(f.select=function(a){return function(c){return b.$apply(function(){return a(c)})}}(f.select)),e=new zh.ui.Suggest(c[0],f),b.$on("destroy",function(){return e.destroy()})}}}])}.call(this),function(){app.directive("uiSummary",["$filter",function(a){return{scope:{content:"=uiSummary",max:"="},link:function(b,c,d){var e,f;return e=b.max||null,f=a("truncateHtml")(b.content,e,null,!0),f.truncated?c.prepend(f.output):c.html(f.output)}}}])}.call(this),function(){app.directive("uiSpinner",["support",function(a){return{restrict:"A",replace:!0,template:'<div class="ui-spinner"></div>',link:function(b,c,d){var e;return e=d.uiSpinner||a.cssAnimation&&"use-css"||"use-gif",c.addClass(e)}}}])}.call(this),function(){app.directive("uiTabTrigger",function(){return{restrict:"A",link:function(a,b,c){var d,e,f;return d=13,f=Number(c.uiTabTrigger)||d,e=function(){return angular.element("input, textarea, a, [contentEditable]").get()},b.bind("keydown",function(a){var b,c,d;return a.keyCode===f?(a.preventDefault(),b=e(),c=b.indexOf(this),c&&(d=b[c+1]),d?d.focus():void 0):void 0})}}})}.call(this),function(){app.directive("uiDroppable",function(){return function(a,b,c){var d,e,f,g,h,i,j,k;return i="droppable",d="active",e=function(a){return a.preventDefault(),a.stopPropagation(),a.dataTransfer.dropEffect="copy"},k=function(a){return a.dataTransfer.types&&-1!==a.dataTransfer.types.indexOf("Files")?(a.dataTransfer.dropEffect="none",a.preventDefault(),a.stopPropagation()):void 0},g=angular.element(document),h={"dragover dragenter":function(a){return k(a.originalEvent),b.addClass(d)},"drop dragleave":function(a){return b.removeClass(d)}},j={"dragover dragenter":function(a){return e(a.originalEvent),b.addClass(i)},"drop dragleave":function(a){return b.removeClass(i)}},f=function(a,b,c){var d,e,f;f=[];for(d in c)e=c[d],f.push(a[b](d,e));return f},f(g,"on",h),f(b,"on",j),a.$on("$destroy",function(){return f(g,"off",h),f(b,"off",j)})}})}.call(this),function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};app.directive("uiPopover",["$parse","$timeout",function(b,c){return{restrict:"A",scope:!1,replace:!0,transclude:!0,template:'<div class="ui-popover" ng-show="show" ng-transclude></div>',link:function(b,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r;return i={align:"overlay",selector:"",container:document.body},k=angular.extend(i,b.$eval(e.popoverOptions)),h=angular.element(k.container),o=k.selector,f=k.align,d.addClass(f),p=a.call(d[0].style,"pointerEvents")>=0,l=function(a){var b;return a.target===d[0]?(d.hide(),b=document.elementFromPoint(a.clientX,a.clientY),d.show(),b.click()):void 0},r="overlay"===f,r&&!p&&d.on("click",l),g=null,j=!1,q=function(a){return a?(j=!1,b.$apply(function(){return b.show=!0})):(j=!0,c(function(){return j?b.show=!1:void 0}))},n={overlay:function(a){return["marginLeft","marginRight","marginTop","marginBottom"].forEach(function(a){return d.css(a,g.css(a))}),d.css(g.position()),d.width(g.width()),d.height(g.height())}},m=function(){return n[f](g[0].getBoundingClientRect())},d.on("mouseenter",function(a){return q(!0)}).on("mouseleave",function(a){return q(!1)}),h.on("mouseenter",o,function(a){return g=angular.element(a.target),m(),q(!0)}).on("mouseleave",o,function(a){return q(!1)}).on("input change",function(){return g&&!h[0].contains(g[0])?q(!1):void 0}),b.removeAnchor=function(){return g.remove(),g=null},b.$on("$destroy",function(){return g=null})}}}])}.call(this),function(){app.directive("uiCopyrightCheck",["$location","$timeout","$window",function(a,b,c){return{restrict:"A",link:function(d,e,f){var g,h,i,j,k,l,m;return i=function(b,c){var d,e,g;return g=f.entryUrl,"http"!==g.slice(0,4)&&(g=""+a.protocol()+"://"+a.host()+g),e=["作者："+f.authorName,"链接："+g,"来源：知乎","著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"],d=["",""],e=c?e.concat(d):d.concat(e),e.join(b)},k=function(a){return a.textContent},j=function(a){return $("<div />").html(a).html()},g=function(a,b){var c;return c=i("<br />",b),b?"<div>"+c+a+"</div>":"<div>"+a+c+"</div>"},h=function(a,b){var c;return c=i("\n",b),b?""+c+a:""+a+c},l=function(){var a;return window.getSelection?a=window.getSelection().toString():document.selection&&"control"!==document.selection.type?a=document.selection.createRange().text:""},m=function(a){var d,e,f,i,m,n,o;return c.getSelection&&(o=c.getSelection(),i=o.getRangeAt(0),e=i.cloneContents(),n=$.trim(k(e)),m=$.trim(j(e)),n&&n.length>128)?(f=n.length>=512,"object"==typeof a.originalEvent.clipboardData&&(a.originalEvent.clipboardData.setData("text/html",g(m,f)),a.originalEvent.clipboardData.setData("text/plain",h(l(),f)),a.originalEvent.clipboardData.getData("text/plain").length>0)?void a.preventDefault():(d=$(g(m,f)).css({position:"fixed",left:"-9999px"}).appendTo("body"),o.selectAllChildren(d.get(0)),b(function(){return d.remove(),o.removeAllRanges(),o.addRange(i)}))):void 0},e.on("copy",m)}}}])}.call(this),function(){app.directive("uiDirectMessage",["DM",function(a){return{restrict:"A",replace:!0,scope:{title:"@",mode:"@",show:"=",user:"="},templateUrl:"/views/direct-message.html",controller:["$scope","$element","$attrs",function(b,c,d){return b.$watch("show",function(a){}),b.close=function(){return b.show=!1},b.send=function(){var c;return b.show=!1,c=b.dmMessage,b.dmMessage="",a.create({slug:b.user.slug,content:c})}}]}}])}.call(this),function(){app.directive("uiInputExpand",["$timeout",function(a){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){var e,f,g;return g=function(){var a,d;return a=!1,b.width(1),b.val()||(a=!0,b.val(c.placeholder)),d=Math.max(b.prop("scrollWidth"),parseInt(b.css("min-width"),10)),d=Math.min(d,+c.maxWidth),b.css({width:d+2}),a?b.val(""):void 0},e=function(){var a;return a=+c.maxWidth||"",b.width(a)},b.bind("focus",function(){return e()}),b.bind("blur",function(){return g()}),g(),f=!1,a.$watch(d,function(){return f||g(),f=!0})}}}])}.call(this),function(){app.directive("uiFormLinkage",["$timeout","$parse","$window",function(a,b,c){return{restrict:"A",require:["?ngModel","^form"],scope:!0,link:function(d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;return x=angular.element(c),w=e.find(".tips"),j=e.find(".error"),n=e.find("input"),n.length||(n=e.find("textarea")),h=e.find(".save-btn"),o=Math.min(+n.attr("max-width"),n.parent().width()),o&&w.width(o),o&&j.width(o),m=f.initValue||"",s=m,i=!0,r=g[0],q=g[1],x.width()<660&&(i=!0),p=r?b(f.ngModel):null,l=function(){return p?p(d)||"":n.val()},u=function(a){return p?p.assign(d,a):n.val(a)},v=function(){var a,b;return a=!1,n.width(1),l()||(a=!0,n.val(n.attr("placeholder")||"")),b=Math.max(n.prop("scrollWidth"),parseInt(n.css("min-width"),10)),n.css({width:b+2}),a?n.val(""):void 0},k=function(){var a;return a=o||"",n.width(a)},t=function(){return w.removeClass("show"),h.removeClass("show"),i?void 0:v()},i?n.css({width:o}):a(function(){return v()}),n.on("focus",function(){return w.addClass("show"),h.addClass("show"),i?void 0:k()}),n.on("blur",function(){return l()===m?a(function(){return t()},100):void 0}),h.on("click",function(){var a;return a=l(),s=a}),d.cancel=function(){return u(m),q&&q.$setPristine(),a(function(){return t()})},d.$on("edit:success",function(a,b){return m=s,b===q?t():void 0})}}}])}.call(this),function(){app.directive("uiReviewButton",function(){return{restrict:"AE",scope:{postSlug:"=postid",draft:"=",uiOpen:"&",uiClose:"&"},templateUrl:"/views/write/review.html",replace:!0,link:function(a){},controller:["$scope","$attrs","$element","$interpolate","$timeout","$resource",function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n;return a.myAvailableColumns=null,a.showColumn=!0,h=f("/api/me/available_columns"),a.handleReviewOpen=function(){return a.uiOpen&&a.uiOpen(),a.myAvailableColumns?void 0:h.query(function(b){return a.myAvailableColumns=b,b.length?void 0:a.showColumn=!1})},a.showAvailableColumn=!1,a.showSelectFriends=!1,a.showSuggestFriends=!1,a.invitedFriends=[],a.selectedFriends=[],a.invitedColumn=a.selectedColumn=null,a.handleReviewClose=function(){return a.uiClose&&a.uiClose(),a.showAvailableColumn=!1},a.handleAddReviewColumn=function(b){return b.stopPropagation(),a.showAvailableColumn?a.showAvailableColumn=!1:a.selectedColumn?"reviewing"!==a.draft.state?a.selectedColumn=null:void 0:(a.showAvailableColumn=!0,a.showSuggestFriends=!1)},a.handleSelectReviewColumn=function(b){return a.showAvailableColumn=!1,a.selectedColumn=b},a.handleRootClick=function(b){return angular.element(b.target).closest(".add-button").length||(a.showAvailableColumn=!1,angular.element(b.target).closest(".ui-suggest").length)?void 0:a.showSuggestFriends=!1},a.removeReviewUser=function(b,c,d){return a.selectedFriends.splice(c,1),d.stopPropagation()},a.toggleFriends=function(b){return a.showSelectFriends=!a.showSelectFriends,a.showSelectFriends&&!a.selectedFriends.length?(b.stopPropagation(),a.showSuggestFriends=!0,e(function(){return c.find(".invite-friends input").focus()})):void 0},a.handleAddFriends=function(){return a.showSuggestFriends?a.showSuggestFriends=!1:(a.showSuggestFriends=!0,a.showAvailableColumn=!1,e(function(){return c.find(".invite-friends input").focus()}))},i=f("/api/posts/"+a.postSlug+"/review"),a.submit=function(){return i.save({users:a.selectedFriends.map(function(a){return a.slug}),column:a.selectedColumn&&a.selectedColumn.slug},function(){return a.showSuccess=!0,a.invitedColumn=a.selectedColumn,a.invitedFriends=a.selectedFriends.slice(0),e(function(){return angular.element(document.body).click(),a.showSuccess=!1,a.canSubmit=!1,a.$emit("review:active",a.selectedColumn||a.selectedFriends.length)},2e3)})},j=!1,i.get(function(b){return b.users.length&&(a.selectedFriends=b.users,a.showSelectFriends=!0,a.invitedFriends=a.selectedFriends.slice(0)),a.selectedColumn=b.column,a.invitedColumn=a.selectedColumn,(a.selectedColumn||a.selectedFriends.length)&&a.$emit("review:active",!0),j?void 0:(j=!0,n())}),n=function(){return a.$watchCollection("[selectedFriends.length, selectedColumn]",function(b,c){return b[0]!==c[0]||b[1]!==c[1]?a.canSubmit=!0:void 0})},k=function(){return a.selectedFriends=a.invitedFriends.slice(0),a.selectedColumn=a.invitedColumn},a.$on("panelOpen",function(a,b){return b?void 0:k()}),l=d('<div class="row">\n  <img class="avatar-small" src="{{avatar | avatarUrl:36}}"/><span class="name">{{name}}</span>\n</div>'),m=null,g=null,a.suggestOptions={source:"/api/me/friends",select:function(b){return a.selectedFriends.push(b),a.showSuggestFriends=!1,""},handleInput:function(){return null!=g?g.hide().html(""):void 0},render:function(b,d,f){var h,i,j,k;return m&&(e.cancel(m),(null!=g?g.length:void 0)&&g.hide(),m=null),f.length?(j=a.selectedFriends.map(function(a){return a.slug}),k=f.filter(function(a){return-1===j.indexOf(a.data.slug)}),i=k.map(function(a){return l(a.data)}).join(""),d.innerHTML=i):(h=c.find(".invite-friends input[ui-suggest]"),h.val()?m=e(function(){return g=angular.element(d),g.html('<div class="no-result">没有这个好友，可能你们不是相互关注。</div>'),g.show().css("opacity",1),m=null},500):void 0)}}}]}})}.call(this),function(){app.directive("uiScrollBackFixed",["$window","$timeout",function(a,b){return{restrict:"A",scope:{fixed:"="},link:function(c,d,e){var f,g,h,i,j,k,l,m,n,o;return o=angular.element(a),i="sbfixed",j="sbfixed-show",c.$watch("fixed",function(){return c.fixed?f():m()}),f=function(){return o.on("scroll",h),o.on("scroll",g)},m=function(){return o.unbind("scroll",h),o.unbind("scroll",g),d.removeClass(i)},n=0,l=!1,k=0,h=function(a){var b;return b=o.scrollTop(),k?b>k?(k=0,l&&d.removeClass(j),l=!1):k-b>10?(l||d.addClass(j),l=!0,k=0):void 0:k=b},g=function(a){return o.scrollTop()>60&&!d.hasClass(i)?(d.hide(),d.addClass(i),b(function(){return d.show()})):o.scrollTop()<60&&d.hasClass(i&&!d.hasClass(j))?(d.removeClass(i),d.removeClass(j)):o.scrollTop()<=0?(d.removeClass(i),d.removeClass(j)):void 0},c.$on("$destroy",function(){})}}}])}.call(this),function(){app.directive("uiFollowButton",["$rootScope",function(a){return{scope:{following:"=ngModel"},link:function(b,c,d,e){var f,g,h;return g=a.supportTouch,f="normal",h=function(){return b.following?(c.html("hovering"===f?"取消关注":"已关注"),c.addClass("btn-grey").removeClass("btn-green")):(c.html("关注专栏"),c.addClass("btn-green").removeClass("btn-grey"))},g||c.on("mouseenter mouseleave",function(a){return b.following&&c.html("mouseenter"===a.type?"取消关注":"已关注"),f="mouseenter"===a.type?"hovering":"normal"}),b.$watch("following",function(){return h()}),h()}}}])}.call(this),function(){app.directive("uiTypewriter",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){var e,f,g,h,i;return g=c.html(),f=g.length,i=g.split(""),c.addClass("ui-typewriter"),e=0,(h=function(){var b,d;return b=i.slice(0,e),c.html(b),d=300,e===f?(d=2e3,e=0):e++,a(h,d)})()}}}])}.call(this),function(){app.directive("uiHoverTitle",["$timeout","$rootScope","mediator",function(a,b,c){return{restrict:"A",link:function(d,e,f){var g,h,i,j;return i=b.supportTouch,e.addClass("hover-title"),c.subscribe("hovertitle:disable",function(){return h(!1)}),c.subscribe("hovertitle:enable",function(){return h(!0)}),g=!0,h=function(a){return g=a,a?void 0:e.removeClass("hover")},i?void 0:(j=null,e.on("mouseenter mouseleave",function(b){return g?"mouseenter"===b.type?j=a(function(){return e.addClass("hover")},300):(j&&a.cancel(j),e.removeClass("hover"),j=null):void 0}))}}}])}.call(this),function(){app.directive("uiOpenBlank",["$timeout","$rootScope","$window",function(a,b,c){return{restrict:"A",link:function(a,d,e){return b.supportTouch?void 0:d.bind("click",function(a){return a.preventDefault(),c.open(a.currentTarget.href)})}}}])}.call(this),function(){app.directive("uiPlaceholder",["$timeout",function(a){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){var e,f,g;return f=c.uiPlaceholder||"",g=function(){return b.attr("placeholder",f)},e=function(){return b.attr("placeholder","")},g(),b.on("focus",e).on("blur",g),a.$on("$destroy",function(){return b.off("focus",e).off("blur",g)})}}}])}.call(this),function(){app.directive("uiBadge",function(){return{restrict:"E",scope:{isOrg:"=",badge:"=",size:"@"},template:'<a href="https://www.zhihu.com/question/48510028/answer/111228381" target="_blank"\n    ng-if="isOrg" ng-class="\'OrgBadge z-ico-badge\'+size"\n    ui-hover-title="已认证的机构"></a>\n<span ng-if="badge">\n  <a href="https://www.zhihu.com/question/48510028/answer/111228381" target="_blank"\n      ng-if="badge.identity && badge.best_answerer"\n      class="ico ico-badge ico-badge-id-an hover-title--nowrap"\n      ui-hover-title="优秀回答者 · 已认证的个人"></a>\n  <a href="https://www.zhihu.com/question/48510028/answer/111228381" target="_blank"\n      ng-if="badge.identity && !badge.best_answerer"\n      class="ico ico-badge ico-badge-identity hover-title--nowrap"\n      ui-hover-title="已认证的个人"></a>\n  <a href="https://www.zhihu.com/question/48509984/answer/111228361" target="_blank"\n      ng-if="!badge.identity && badge.best_answerer"\n      class="ico ico-badge ico-badge-best_answerer hover-title--nowrap"\n      ui-hover-title="优秀回答者"></a>\n</span>'}})}.call(this),function(){app.directive("uiNumCode",["$timeout","$window",function(a,b){return{restrict:"AE",replace:!0,templateUrl:"/views/num-code.html",controller:["$scope","$element",function(a,b){return a.inputValues=[],a.inputs=Array.apply(null,Array(6)).map(function(b,c){return a.inputValues[c]="",{name:"nc"+c}})}],link:function(b,c){var d,e,f,g;return f=0,g=function(){return a(function(){return c.find("input").eq(f).focus()})},b.$on("reset:code",function(a,c){return b.inputValues.forEach(function(a,c){return b.inputValues[c]=""}),f=0,c?g():void 0}),b.handleFocus=function(a,b){return b!==f?(g(),""):void 0},e=9,d=8,b.handleInput=function(a,c){var h;if(a.keyCode!==e){if(a.keyCode===d)return a.preventDefault(),b.inputValues[c]="",void(c>0&&(f=--c,b.inputValues[c]="",g()));if(a.preventDefault(),h=Number(String.fromCharCode(a.keyCode)),!isNaN(h))return b.inputValues[c]=h,c+1<b.inputs.length?(f++,g()):b.$emit("numcode:change",b.inputValues.join("")),""}},g()}}}])}.call(this),function(){app.controller("AppCtrl",["$scope","$rootScope","$location","$timeout","$resource","columnResolver","dialog","Column","me","loginDialog","activateDialog","sharedData","globalAlert","docTitle","mediator","bracketBlinkFix","domainConfig",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r;return a.$on("$routeChangeStart",function(a,b){}),a.$on("$routeChangeSuccess",function(e,f){var g,h;return a.pageClass=f.pageClass,d(function(){return c.hash()?void 0:(document.documentElement.scrollTop=0,document.body.scrollTop=0)}),f.params.columnSlug||f.params.userColumnSlug?(g=b.column,h=g?g.name:"",f.pageTitle?n.push(f.pageTitle,h):n.push(h)):n.push(f.docTitle||f.pageTitle),a.title=n.get()}),r=function(){return i.columns.unshift({url:"/u/"+i.slug,name:"我的文集",avatar:i.avatar})},b.me=i,o.subscribe(["column:create","column:remove","column:edit","column:activate","column:request"],function(){return i.refresh()}),a.navbarTemplateUrl="/views/navbar.html",a.globalAlert=m,o.subscribe("accountcallback",function(a){return a.login?(j.close(),i.refresh()):this.returnValue=!1}),a.showLoginDialog=function(){return j.open(this)},a.$on("event:loginRequired",function(){return a.showLoginDialog()}),a.$on("event:activateRequired",function(){return k.open(a)}),a.$on("event:notMutedRequired",function(){return g.message("由于多次违反社区规范，您的账户暂时无法发言")}),a.showNavColumnsSelector=function(){return a.navColumnsSelectorShow=!0},a.navToColumn=function(a){return c.url("/"+a.slug)}}])}.call(this),function(){app.controller("ReviewCommentCtrl",["$scope","$element",function(a,b){var c,d;return a.post=a.draft||a.post,c=a.post.slug||a.post.id,a.commentsHref="/api/posts/"+c+"/comments?type=review",a.fold=!0,a.handleToggle=function(){return"published"!==a.post.state?a.fold=!a.fold:void 0},d=new zh.ui.Scroller,a.$on("commentLoaded",function(b,c,e){return d.decorate(c.find(".comment-list-container")[0]),d.enter(),e.length?a.fold=!1:void 0}),a.$on("$destroy",function(){return null!=d&&d.exit(),null!=d?d.dispose():void 0})}])}.call(this),function(){app.controller("HomeCtrl",["$scope","$window","$timeout","$rootScope","HomeRecommend","winType","dialog","me","ga",function(a,b,c,d,e,f,g,h,i){var j,k,l,m,n,o;return n=angular.element(b),a.winType=o=f.get(),e.updateWinType(o),e.init(),a.recommendColumns=e.recommendColumns,a.newestColumns=e.newestColumns,a.recommendPosts=e.recommendPosts,l=a.$watch("recommendColumns.length",function(){return a.recommendColumns.length?(a.recommendColumnsInited=!0,l()):void 0}),m=a.$watch("recommendPosts.length",function(){return a.recommendPosts.length?(a.recommendPostsInited=!0,m()):void 0}),j=function(a){var b;return b=angular.element(a.target).closest(".btn"),angular.element(b).addClass("loading"),c(function(){return angular.element(b).removeClass("loading")},900)},a.nextRecommendColumn=function(a){return e.nextRecommendColumn(),j(a)},a.nextRecommendPost=function(a){return e.nextRecommendPost(),j(a)},a.nextNewestColumn=function(a){return e.nextNewestColumn(),j(a)},a.handleLoginBeforeJump=function(a,c){return h.authed()?c&&h.pendingColumns&&h.pendingColumns.length?(g({title:"专栏创建申请",cssClass:"message",buttons:{},content:"你的专栏创建申请正在受理中。同时只能申请一个专栏。"}).open(),void a.preventDefault()):d.supportTouch?void 0:(a.preventDefault(),b.open(a.currentTarget.href),0):(d.$broadcast("event:loginRequired"),void a.preventDefault())},a.handleRecommendColumnClick=function(){return i.track("column","visit_column","column_index_page_recommendation")},k=function(){var b;return b=f.get(),o!==b?(e.updateWinType(b),a.winType=o=b,a.$apply()):void 0},n.on("resize",k),a.$on("$destroy",function(){return n.off("resize",k)})}])}.call(this),function(){app.controller("PostCommentsCtrl",["$rootScope","$scope","$resource","$location","$anchorScroll","$timeout","$element","$attrs","$http","$window","dialog","reportService","requireActivate","requireNotMuted","me","linkHeaderSource",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q,r,s,t,u,v,w,x,y,z,A;return b.loadStyle=h.commentsStyle||"infinite",b.placeholder=b.placeholder||"写下你的评论",b.state=b.state||"normal",b.addHref=b.addHref||b.href,b.$watch("addHref",function(){return b.addHref=b.addHref||b.href}),t={},-1===b.href.indexOf("?")?z=b.href+"/:id/:action":(A=b.href.split("?"),z=A[0]+"/:id/:action",A[1].split("&").forEach(function(a){return a=a.split("="),t[a[0]]=a[1]})),q=c(z.replace(/\/\d+\/conversation\/.+$/,"/:id/:action"),angular.extend({id:"@id"},t),{like:{method:"PUT",params:{action:"like"}},approve:{method:"PUT",params:{action:"approve"}},dislike:{method:"DELETE",params:{action:"like"}},reply:{method:"POST",params:{action:"reply"}},recommend:{method:"PUT",params:{action:"featured"}},unRecommend:{method:"DELETE",params:{action:"featured"}}}),b.scraperOptions={handlers:{image:function(){}},attachActionBar:!b.disableScraper},b.loadedOnce=!1,b.$watch("expanded",function(a){return a&&!b.loadedOnce&&"infinite"===b.loadStyle?b.loadComment():void 0}),s=b.comments=[],b.featureComments=[],x=function(a){var c,e;return null==a&&(a={}),"infinite"===b.loadStyle?(z=-1===b.href.indexOf("?")?""+b.href+"?limit=20":""+b.href+"&limit=20",
e=b.source=p.create(z,s),c=function(a){return!s.some(function(b){return b.id===a.id})},e.onadd=function(a){return s.push.apply(s,a.filter(c).map(function(a){return new q(a)}))},e.onnext=function(){return e.url=e.url.replace(/limit=\d+/,"limit=50")},b.pending=!0,b.loadComment=function(){return b.loadedOnce=!0,e.fetch()["finally"](function(){return b.pending=!1,f(function(){return b.$emit("commentLoaded",g,b.comments)})})}):(b.locateItemIndex=a.index,b.oriComments=[],b.pending=!1,b.$on("pagination:loaded",function(a,c){return b.featureComments=[],b.comments=s=[],b.oriComments.forEach(function(a){return b[a.featured?"featureComments":"comments"].push(new q(a))}),f(function(){return b.$emit("commentLoaded",g,b.comments)})}),b.$on("pagination:firstInit",function(){return f(function(){var a;if(b.locateCommentId>0){if(a=angular.element("#comment-"+b.locateCommentId),a.length)return angular.element(j).scrollTop(a.offset().top)}else if(-1!==d.hash().indexOf("comments"))return angular.element(j).scrollTop(g.offset().top)})}),b.$on("pagination:change",function(a,b){return angular.element(j).scrollTop(g.offset().top)}))},b.locateCommentId?i.get(""+b.href+"/"+b.locateCommentId+"/pos").then(function(a){return x(a.data)}):x(),b.me=o,b.loadMore=function(){return b.source.fetch()["finally"](function(){return f(function(){return b.$emit("commentMoreLoaded",g,b.comments)})})},b.ownPost=function(){return o.slug===this.postOwner.slug},b.ownComment=function(a){return o.slug===a.author.slug},b.canRemove=function(a){return this.ownPost()&&!a.reviewing||this.ownComment(a)},b.isPostOwner=function(a){return a&&a.slug===this.postOwner.slug},b.canReply=function(a){return o.authed()&&this.status.canComment&&!this.ownComment(a)&&!a.reviewing},b.report=m(function(a){return l(a,"comment",this)}),y=function(a){return b.status.pageCount-=1,a.reviewing||(b.status.count-=1),a.deleted=!0},b.remove=function(a){return k.confirm(this,"删除评论","确定删除这条评论？",function(){return y(a),a.$remove()})},b.approve=function(c){return b.status.count+=1,b.status.pageCount+=1,b.status.reviewingCount-=1,b.oriComments=b.oriComments.filter(function(a){return a.id!==c.id}),c.$approve().then(function(){return a.$broadcast("pagination:reloadcurrent")})},w={content:""},b.editingComment=w,b.savePending=!1,r=function(){return b.savePending=!1},b.addComment=m(n(function(){return this.commentForm.$invalid?k.message("评论内容必须填写"):(b.savePending=!0,i.post(b.addHref,{content:w.content}).then(function(a){var c;return c=new q(a.data),r(),w.content="",b.status.pageCount+=1,c.reviewing||(b.status.count+=1),"infinite"===b.loadStyle?b.comments.push(c):b.$broadcast("pagination:loadlast"),b.formExpanded=!1},r))})),b.like=m(function(a){return a.liked=!a.liked,a.liked?(a.likesCount+=1,a.$like()):(a.likesCount-=1,a.$dislike())}),b.recommend=m(function(a){return a["$"+(a.featured?"unRecommend":"recommend")]().then(function(b){return a.featured=!a.featured})}),b.viewConversation=function(a){return k.fromUrl("/views/conversation.html",{controller:"ConversationDialogCtrl",scope:b,resolve:{entry:a}}).then(function(a){return a.open()})},b.formExpanded=!1,b.expandForm=m(n(function(a){return b.formExpanded=a,!b.formExpanded&&document.getSelection?document.getSelection().removeAllRanges():void 0})),b.toggleReplyForm=n(function(a){return a.hidden=!a.hidden}),b.replyComment=m(n(function(a,c,d){return d.$invalid?k.message("回复内容必须填写"):(c.pending=!0,q.reply({id:a.id},{content:c.content},function(a){return c.content="",c.hidden=!0,c.pending=!1,b.status.pageCount+=1,a.reviewing||(b.status.count+=1),b.comments.push(a)}))})),b.commentSettingMenuItems=o.isOrg?[{value:"anyone",text:"开放评论"},{value:"review",text:"预审评论"},{value:"none",text:"关闭评论"}]:[{value:"anyone",text:"所有人都能评论该文章"},{value:"friends",text:"只有作者关注的人才能评论该文章"},{value:"none",text:"关闭评论"}],b.onClickCommentSettingItem=function(a){var c,d,e,f;return e=b.status.permission,d=a.target.value,e!==d&&d&&"review"===e?(a.preventDefault(),a.stopImmediatePropagation(),"anyone"===d?(f="开放评论",c="开放评论后，评论提交即公开显示。<br/>当前所有待审核评论不会公开，为您自动保存，若切换回预审评论可以继续审核。"):"none"===d&&(f="关闭评论",c="关闭评论后，所有人无法提交评论。<br/>当前所有待审核评论不会公开，为您自动保存，若切换回预审评论可以继续审核。"),k.confirm(this,f,c,function(){return b.status.permission=d})):void 0},b.commentHrefMap={normal:b.href,reviewing:""+b.href+"?status=reviewing"},b.commentCountMap={normal:{count:b.status.pageCount},reviewing:{count:b.status.reviewingCount}},b.$watch("status.pageCount",function(){return b.commentCountMap.normal={count:b.status.pageCount}}),b.$watch("status.reviewingCount",function(){return b.commentCountMap.reviewing={count:b.status.reviewingCount}}),b.toggleCommentsType=function(c,d){return null!=c&&c.preventDefault(),b.state=d,f(function(){return a.$broadcast("reload")})},u=angular.element(document),b.handleInputFocus=function(a){return b.expandForm(!0),a.target.focus(),f(function(){return a.target.focus()}),u.on("click",v),""},v=function(a){return angular.element(a.target).closest(".comment-form").length?void 0:(b.$apply(function(){return b.expandForm(!1)}),u.off("click",v))},b.$on("event:loginRequired",function(){return f(function(){return document.activeElement.blur()},100)}),b.$on("commentPermissionChange",function(a,c){return"review"===c&&"normal"!==b.state?b.toggleCommentsType(null,"normal"):void 0})}])}.call(this),function(){app.controller("NavbarCtrl",["$scope","$rootScope","$location","$element","$timeout","$route","$sce","$window","columnResolver","docTitle","me","requireActivate","mediator","sharedData","ga",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p,q;return q=d.find(".navbar-title-container"),a.showReview=!1,a.inWrite=!1,a.showTitle=!0,a.status=null,a.extraStatus=null,a.hideDelete=!1,a.inPostList=!1,a.inIndex=!1,a.$on("$routeChangeStart",function(b,c){return a.title=null,a.showReview=!1,a.showTitle=!0,a.status=null,a.extraStatus=null,a.hideDelete=!1,a.inPostList=!1}),a.inIndex=!1,a.scrollBackFixedNavbar=!0,a.$on("$routeChangeSuccess",function(b,d){var e;return a.scrollBackFixedNavbar=!d.disableScrollBackFixedNavbar,a.inWrite="PostWriteCtrl"===d.controller,a.inWrite&&(a.draftId=null!=(e=c.path().match(/p\/(\d+)\/edit/))?e[1]:void 0),a.inPostList="PostsCtrl"===d.controller,a.inIndex="HomeCtrl"===d.controller}),a.$on("routeSilentChangeSuccess",function(b){var d;return d=c.path().match(/p\/(\d+)\/edit/),d?(a.inWrite=!0,a.draftId=d[1]):void 0}),a.$on("$routeChangeStart",function(b,c){return a.columnSelectOnly=!1}),a.$watch("inPostList",function(){return a.inPostList?e(function(){return q.addClass("anim")},100):q.removeClass("anim")}),a.toggleFollow=function(a,b){var c;return b.preventDefault(),b.stopPropagation(),c=a.following?"click_follow_column":"click_unfollow_column",o.track("column",c,"column_navigation_bar"),a.toggleFollow()},a.deleteDraft=function(){return m.publish("draft:remove")},a.handleGoColumn=function(){return n.remove("column_data")},a.goWrite=l(function(){return c.url("/write")}),a.handleTitleClick=function(a){return"a"===a.target.tagName.toLowerCase()?o.track("column","visit_column","column_navigation_bar"):void 0},""===document.body.style.webkitBackdropFilter&&d.addClass("backdrop"),m.subscribe("navbar:setTitle",function(b){return a.title=b,a.title.subtitle=a.title.sub,e(function(){return b.buttons?d.find(".functions").append(b.buttons):void 0})}),m.subscribe("navbar:setStatus",function(b){return a.status=b}),m.subscribe("navbar:setExtraStatus",function(b){return a.extraStatus=b}),p=function(a,b){var c;return a.$root?(c=a.$root.$$phase,"$apply"===c||"$digest"===c?a.$eval(b):a.$apply(b)):void 0},m.subscribe("navbar:hideTitle",function(){return p(a,function(){return a.showTitle=!1})}),m.subscribe("navbar:showTitle",function(){return p(a,function(){return a.showTitle=!0})}),m.subscribe("navbar:menuDisable",function(){return a.disableMenu=!0}),m.subscribe("navbar:menuEnable",function(){return a.disableMenu=!1}),m.subscribe("navbar:hideDeleteDraft",function(){return a.hideDelete=!0}),m.subscribe("navbar:showDeleteDraft",function(){return a.hideDelete=!1})}])}.call(this),function(){app.controller("PostsCtrl",["$scope","$http","$location","$route","$resource","$filter","$window","$timeout","column","linkHeaderSource","globalAlert","mediator","Post","contributeService","reportService","followButton","docTitle","sharedData","dialog","me","wx","ga",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){var w,x,y,z,A,B,C,D,E,F,G,H,I;return w="column_data",I=angular.element(g),a.showTopicNum=3,i.postTopics.sort(function(a,b){return b.postsCount-a.postsCount}),a.column=i,a.columnType=-1!==c.path().search(/^\/u\//)?"user":"column",D=function(){return["CD",a.columnType,a.column.slug,a.currentTopic?a.currentTopic.id:"",a.currentAuthor?a.currentAuthor.slug:""].join("_")},A=i.postTopics.filter(function(a){return a.name===c.search().topic||a.id===c.search().topic}),a.currentTopic=A=A[0],z=c.search().author,x=e("/api/users/"+z),z&&(a.currentAuthor=x.get()),a.originPosts=[],E=function(b){var c;return c=""+i.href+"/posts?limit=20",b.topic?c+="&topic="+b.topic.id:b.author&&(c+="&author="+b.author),a.postsSource=j.create(c,a.originPosts,m)},C=function(){var b;return b=e("/api/columns/"+i.slug+"/pins"),a.recommendPosts=b.query(),a.recommendPosts.$promise.then(function(){return a.recommendPostsFetched=!0})},a.$watchCollection("[postsSource.completed, originPosts.length, recommendPostsFetched]",function(){var b,c;return a.originPosts.length||a.postsSource.completed?((null!=(c=a.recommendPosts)?c.length:void 0)?(b=a.recommendPosts.map(function(a){return a.slug}),a.posts=a.originPosts.filter(function(a){return-1===b.indexOf(a.slug)})):a.posts=a.originPosts,a.feedInited=!0):void 0}),B=r.get(w),B&&(D()===B[0]&&(G=B[1]),r.remove(w)),H=a.$watch("feedInited",function(){return a.feedInited?(h(function(){return G?I.scrollTop(G):void 0}),H()):void 0}),A||z||"user"===a.columnType||C(),E({topic:A,author:z}),a.ownColumn=function(){return i.creator.slug===t.slug},a.authorType={author:["作者","可发布文章到该专栏"],editor:["编辑","可管理、发布文章到该专栏"]},y=""+i.href+"/authors/"+t.slug+"/activate",a.activateAuthor=function(){return b.put(y).success(function(){return l.publish("column:activate",i),a.showActivateAuthorSuccess=!0,h(function(){return i.canPost=!0,d.reload()},2e3)})},a.dismissActiveAuthor=function(){return b["delete"](y).success(function(){return i.activateAuthorRequested="none"})},i.read(),a.handleContribute=function(){return t.isOrg&&!i.canManage?s.message("暂不支持非专栏编辑/作者的机构帐号投稿",3e3):n.open(i,this)},a.showMoreTopics=function(){return a.isShowMoreTopics=!0},A&&i.postTopics.some(function(b,c){return b.id===A.id?(c>a.showTopicNum-1&&(a.isShowMoreTopics=!0),!0):void 0}),a.filterTopic=function(a){return a?c.search({topic:a.name}):c.search("")},a.toggleFollow=function(){var a;return a=i.following?"click_follow_column":"click_unfollow_column",v.track("column",a,"column_page"),i.toggleFollow()},a.handleReport=function(){return o(i,"column",this)},a.arrived=function(){return i.firstTime=!1,b.patch(i.href,{firstTime:!1})},q.hide(),q.setNavbarTitle({main:"<a href='"+i.url+"'>"+i.name+"</a>",img:f("avatarUrl")(i.avatar,i.id,"small"),imghref:i.url,buttons:i.canManage||"activated"!==i.activateState?null:[p.get(a)]}),F=function(){var a,b;return a="activated"===i.activateState?angular.element(".column-about .functions"):angular.element(".column-about .description"),I.scrollTop()>(null!=(b=a.offset())?b.top:void 0)?q.show():q.hide()},I.scroll(F),a.$on("$destroy",function(){return I.unbind("scroll",F)}),a.$on("$destroy",function(){return r.set(w,[D(),I.scrollTop()])}),u.update({desc:a.column.intro.slice(0,50),imgUrl:f("avatarUrl")(i.avatar,i.id,"small")})}])}.call(this),function(){app.controller("PostWriteCtrl",["$scope","$rootScope","$q","$timeout","$location","$http","$window","$resource","$filter","$route","dialog","sharedData","Post","draft","Draft","me","domainConfig","globalAlert","preventUnload","debounce","requireNotMuted","mediator","docTitle","Image",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x){var y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T;return a.me=p,H=["title","content","titleImage","column","isTitleImageFullScreen"],a.$emit("postEditRequested"),C=null,Q=function(){return A(),C=d(function(){return location.reload()},18e5)},A=function(){return C?d.cancel(C):void 0},"user"===(null!=(T=n.column)?T.type:void 0)&&(a.userColumn=!0),P=!1,s(a,"草稿尚未保存",function(){return P&&(n.titleImage||n.content||n.title)}),E=n.id,n.topics=n.topics||[],a.showReviewCommentPanel=!1,a.$on("review:active",function(b,c){return a.showReviewCommentPanel=c}),E?n.titleImage&&(n.isTitleImageFullScreen?n.canTitleImageFullScreen=!0:x.getInfo(n.titleImage).then(function(a){return n.canTitleImageFullScreen=x.canTitleImageFullScreen(a.data)})):(H.forEach(function(a){return n[a]=""}),v.publish("navbar:hideDeleteDraft")),n.isTitleImageFullScreen=n.isTitleImageFullScreen||!1,a.draft=n,(n.id||n.slug)&&(G=!0),"published"===n.state&&v.publish("navbar:hideDeleteDraft"),M=function(a,b){return b.reduce(function(b,c){return b[c]=a[c],b},{})},D=function(a,b,c){return(c||Object.keys(a)).map(function(c){return angular.equals(a[c],b[c])?void 0:c}).filter(Boolean)},z=function(){return a.$watch("draft",function(b,c){return a.saveDraft(D(b,c,H))},!0)},d(function(){return z()}),a.back=function(){return g.history.back()},a.errorHint="",K=1e5,a.maxTitleCount=50,a.onContentChange=function(b){var c,d;return d=b.target.textContent,c=K-i("wordlen")(d.trim()),0>c?a.errorHint="超出 "+-c+" 字":a.postForm.title.$valid?a.errorHint="":void 0},a.onContentFocus=function(a){return d(function(){return a.target.focus()})},a.$watch("draft.title",function(){var b;return b=a.maxTitleCount-i("wordlen")(a.draft.title),0>b?a.errorHint="标题超过 "+-b+" 字，无法保存":a.postForm.content.$valid||!a.draft.content?a.errorHint="":void 0}),y=500,a.draftSaving=!1,N=t(500,function(b){var e,f,g;return f=c.defer(),e=d(function(){},y),c.all([f.promise,e]).then(function(){return a.draftSaving=!1,"保存失败"===a.errorHint&&(a.errorHint=""),P=!1},function(){return a.errorHint="保存失败"}),g=M(n,b),Object.keys(g).forEach(function(a){return-1!==["title","content"].indexOf(a)&&"undefined"==typeof g[a]?g[a]="":void 0}),o.patch({postSlug:n.id},g,function(){return f.resolve()},function(){return f.reject()})}),a.draftCreating=!1,O=function(){var b;return b=a.postForm,!a.draftCreating&&(n.title||n.content||n.titleImage)},a.saveDraft=function(b){if(!F&&!a.draftCreating)if(Q(),n.id){if(b.length){if(a.postForm.title.$error.wordMax||a.postForm.content.$error.wordMax)return;return a.draftSaving=!0,P=!0,N(b)}}else if(O())return a.draftCreating=!0,P=!0,o.create(n,function(b){return n.id=b.id,a.draft.author=p,P=!1,e.url("/p/"+n.id+"/edit",!0).replace(),a.errorHint="",v.publish("navbar:showDeleteDraft"),d(function(){return a.draftCreating=!1,a.saveDraft(["title","content"])})},function(b){return a.draftCreating=!1,a.errorHint="保存失败"})},a.removeDraft=function(a){return a.$remove(function(){return r.set("草稿已删除"),e.url(G&&a.url?a.url:"/drafts")})},v.subscribe("draft:remove",function(){return a.removeDraft(a.draft)}),F=!1,a.publish=u(function(b,c){var d;return a.postForm.title.$invalid?k.message("你的文章没有标题。"):a.postForm.content.$invalid?k.message("你的文章没有内容。"):!F&&n.id?(n.column=b||null,c&&(n.commentPermission=c),F=!0,d=n.column&&!n.column.canPost,o.doPublish(n).then(function(a){return P=!1,d?e.url("/drafts"):e.url(a.url)},function(a){var b,c,d;return F=!1,b=a.data,c=(null!=(d=b.errors)?d.length:void 0)?b.errors.map(function(a){return a.message}).join("<br>"):b.message||"服务器提了一个问题，请稍候再试。",k.message(c)})):void 0}),b.$on("columnSelectRequested",function(b,c){return a.showColumnSelector()}),a.showColumnSelector=function(){return a.columnsSelectorShow=!0},a.deleteTitleImage=function(){return a.draft.titleImage="",a.draft.isTitleImageFullScreen=!1,a.draft.canTitleImageFullScreen=!1,""},J="localhost"===e.host(),S=J?"/upload":q.uploadUrl,a.fileuploadOptions={url:S,autoUpload:!0,dropZone:angular.element("#js-title-img"),pasteZone:angular.element(),formData:{via:"xhr2"},xhrFields:{withCredentials:!0},processalways:function(a,b){var c;return c=b.files[b.index],c.error?r.setSync(c.error,"error"):void 0},done:function(a,b){var c,d,e;if(d=b.result,J)n.titleImage=d[0].url,n.isTitleImageFullScreen=Math.random()>.5;else if(0===d.code){if(e=d.msg[1],c=d.msg[2],330>e||100>c)return void r.set("图片太小，请重新上传","error");n.isTitleImageFullScreen=e>=1366&&c>=550,n.titleImage=d.msg[0]}return n.canTitleImageFullScreen=n.isTitleImageFullScreen}},a.toggleFullScreen=function(){return a.draft.isTitleImageFullScreen=!a.draft.isTitleImageFullScreen},a.commentsStatus={count:10,canComment:!0,permission:!0},n.state&&"draft"!==n.state?(B=a.userColumn?"/u/"+n.column.slug:"/"+n.column.slug,"reviewing"===n.state?w.setNavbarTitle({sub:"待发布于 <a href='"+B+"'>"+n.column.name+"</a>",main:"编辑文章"}):"published"===n.state&&w.setNavbarTitle({sub:"user"===n.column.type?"已发布":"已发布于 <a href='"+B+"'>"+n.column.name+"</a>",main:"编辑文章"})):(w.setNavbarTitle({main:"写文章"}),w.push("写文章")),a.canPublish=!1,R=function(){return p.isOrg&&"published"!==n.state&&!L?a.canPublish=!1:a.postForm.title.$valid&&a.postForm.content.$valid&&i("wordlen")(n.title)>=2?a.canPublish=!0:a.canPublish=!1},a.$watchCollection("[postForm.title.$valid, postForm.content.$valid, draft.title]",function(){return R()}),a.$on("draft:cancelReview",function(){return f["delete"]("/api/drafts/"+(n.id||n.slug)+"/publish").then(function(){return j.reload()})}),I=function(){return a.errorHint?{text:a.errorHint,type:"error"}:a.draftSaving||a.draftCreating?{text:"保存中...",type:"loading"}:n.id?{text:"已保存"}:{text:"草稿自动保存"}},w.setStatus(I()),a.$watchCollection("[errorHint, draftSaving, draftCreating]",function(){return w.setStatus(I())}),L=0,p.isOrg&&f.get("/api/me/publish_limit").then(function(a){var b;return L=a.data.remainingPublishCount,R(),L>=0?(b=L?{text:"本周还能发布 "+L+" 篇文章"}:{text:"已达到本周发布上限",type:"error"},w.setExtraStatus(b)):void 0}),a.handlePanelOpen=function(){return v.publish("navbar:menuDisable")},a.handlePanelClose=function(){return v.publish("navbar:menuEnable")},a.$on("$destroy",function(){return A()})}])}.call(this),function(){app.controller("PostViewCtrl",["$scope","$rootScope","$location","$rootElement","$resource","$sce","$http","$route","$filter","$compile","$window","$timeout","$interpolate","dialog","globalAlert","snsShare","docTitle","resources","requireActivate","reportService","me","memoize","recommendService","Recommendation","followButton","winType","Image","sharedData","mediator","wx","ga","zap",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F){var G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_;return O=r.post,I=r.column,"undefined"==typeof O?(a.notFound=!0,angular.element(document.body).addClass("page-empty"),void(S=a.$on("$routeChangeStart",function(a,b){return angular.element(".server-error-container").hide(),angular.element(document.body).removeClass("page-empty"),S(),""}))):(O.titleImage=i("imgSize")(O.titleImage,O.isTitleImageFullScreen&&!b.supportTouch?"r":"b"),"user"===(null!=(_=O.column)?_.type:void 0)&&(a.userColumn=!0),(a.userColumn&&h.current.params.refer||!a.userColumn)&&(G=!0),a.column=I,a.post=O,a.me=u,a.postContentTrustedHtml=f.trustAsHtml(O.content),a.isCensoring="censoring"===O.state,a.isReviewing="reviewing"===O.state||!I&&"draft"===O.state,a.isDraft="draft"===O.state,a.isPublished="published"===O.state,a.titleLine=Math.ceil(i("wordlen")(a.post.title)/20),a.isQQNews=/qqnews/.test(k.navigator.userAgent),l(function(){return a.titleLine=Math.round($("h1.entry-title").height()/45)}),a.moduleInfo={card:{card_type:"Content",content:{type:"Post",token:O.slug.toString()}}},a.ownPost=function(a){var c;return(null!=(c=a.author)?c.slug:void 0)===b.me.slug},a.ownColumn=function(){var a;return(null!=(a=I.creator)?a.slug:void 0)===b.me.slug},a.showReviewPanel=a.isReviewing,I?(q.push(O.title||O.excerptTitle,I.name),a.userColumn||("reviewing"===O.state?q.setNavbarTitle({sub:"待发布于 <a href='"+I.url+"'>"+I.name+"</a>"}):a.isPublished&&q.setNavbarTitle({main:"<a href='"+I.url+"'>"+I.name+"</a>",sub:"首发于",ariaLabel:I.name,img:i("avatarUrl")(I.avatar,I.id,"small"),imghref:I.url,buttons:I.canManage?null:[y.get(a)]}))):q.push(O.title||O.excerptTitle),a.editPost=function(){return c.url(""+O.url+"/edit")},a.removePost=function(){return n.confirm(this,"删除文章","确定删除这篇文章？",function(){return O.remove(function(){return a.userColumn&&h.current.params.refer?c.url("/"+h.current.params.refer):a.userColumn?c.url("/"):c.url("/"+O.column.slug),o.set("文章已删除")})})},a.enableTipjar=function(){return a.$broadcast("tipjar:enable")},a.disableTipjar=function(){return a.$broadcast("tipjar:disable")},a.approveContributeReq=function(b,c){return g.put("/api/columns/"+b.sourceColumn.slug+"/contribute_requests/"+b.id).then(function(){return a.contributeRequests[c].success=1,B.remove("settingsNewContributeNum"),U(b,"approve"),l(function(){return T(c)},2e3)})},a.dismissContributeReq=function(a,b){return g["delete"]("/api/columns/"+a.sourceColumn.slug+"/contribute_requests/"+a.id).then(function(){return T(b),B.remove("settingsNewContributeNum"),U(a,"dismiss")})},T=function(b,c){return a.contributeRequests[b].done=1,a.contributeRequests.every(function(a){return a.done})&&(a.contributeRequests.done=1,"reviewing"===a.post.state)?h.reload():void 0},a.report=s(function(a){return t(a,"post",this)}),a.editMenuItems=[{label:"修改",icon:"icon-postedit",action:a.editPost},{label:"删除",icon:"icon-postdel",action:a.removePost}],Z={sina:"Weibo",dudu:"Dudu"},a.share=Q=function(b,d,e){var f,g,h,i;return f=a.post.author,g="sina"===d&&f.sinaName?"@"+f.sinaName:f.name,h={title:""+O.title+" - "+I.name,url:c.absUrl()},O.snapshotUrl&&(h.pic=O.snapshotUrl),i="dudu"!==d,p.share(d,g,h,i,e),F.trackEvent(b.target,{action:"Share",element:"Menu"},{share:{type:Z[d]}})},P=!1,V="#showWechatShareTip",a.beforeShareMenuOpen=function(){var b;return a.post.author.sinaName||p.getSinaAuthorName(a.post.author.slug).then(function(b){return a.post.author.sinaName=b}),P||new QRCode(angular.element(".ShareQRCode")[0],{text:c.absUrl()+V,width:100,height:100}),P=!0,b=$(".post-share-button"),F.trackEvent(b,{action:"ShareIntent",element:"Button"})},a.touchShare=function(b){return F.trackEvent(b.target,{action:"ShareIntent",element:"Button"}),a.share(b,"sina",!0)},a.shareMenuItems=[{label:"新浪微博",icon:"icon-ic_share_sina",className:"menu-item-sina",action:function(a){return Q(a,"sina")}},{label:"微信扫一扫",icon:"icon-ic_share_wechat",action:function(){},html:f.trustAsHtml('<div class="ShareQRCode"></div>'),className:"menu-item-wechat"},{label:"读读日报",icon:"icon-ic_share_dudu",className:"menu-item-dudu",action:function(a){return Q(a,"dudu")}}],J=function(a,b){var c;return c=-1,a.some(function(a,d){return a.slug===b.slug?(c=d,!0):void 0}),c},R=function(){var b,c;if(c=a.likers||a.post.lastestLikers)if(b=J(c,u),"like"===a.post.rating){if(-1===b)return c.unshift(u)}else if(-1!==b)return c.splice(b,1)},a.$watch("post.rating",R),a.commentsStatus={count:O.commentsCount,reviewingCount:O.reviewingCommentsCount,pageCount:O.pageCommentsCount,canComment:O.canComment,forceShowCommentForm:!u.authed(),permission:O.commentPermission},a.commentNeedReview="review"===O.commentPermission&&!(u.slug===O.author.slug),a.commentsPlaceholder=a.commentNeedReview?"已开启预审评论，评论由机构筛选后公开":"写下你的评论",a.$watch("commentsStatus.permission",function(c,d){return c!==d?(O.commentPermission=a.commentsStatus.permission,a.commentsStatus.canComment="none"!==a.commentsStatus.permission||a.ownPost(O),g.patch("/api/posts/"+O.slug,{commentPermission:O.commentPermission}),b.$broadcast("commentPermissionChange",d)):void 0}),M=c.hash(),/^comment-\d+$/.test(M)&&(a.locateCommentId=+M.match(/^comment-(\d+)$/)[1]),a.recommendPending=!0,N=function(a){return{column:a.sourceColumn,id:a.id,state:a.state}},a.contributes=[],H=function(){var b,c,d,f;return f=[],O.meta.next&&G&&f.push(O.meta.next),O.meta.previous&&G&&f.push(O.meta.previous),d=4-f.length,x.query({type:"posts",limit:d,seed:Math.floor(100*Math.random())},function(b){return b=b.slice(0,d),b=b.map(function(a){return a.showRecommend=!0,a}),a.recommendPosts=f.concat(b),a.recommendPending=!1}),c=e(""+O.href+"/contributed"),c.query(function(b){return b=b.map(N),a.contributes=b}),a.$on("contribute:remove",function(b,c,d){return a.contributes.splice(d,1),g["delete"]("/api/posts/"+O.slug+"/contributed/"+c.id)}),u.slug?(b=e("/api/posts/"+O.slug+"/contribute_requests"),b.query(function(b){return a.contributeRequests=b})):void 0},l(function(){return H()}),a.isContributesAvailable=function(){return a.contributes.some(function(a){return"accepted"===a.state})},U=function(b,c){var d;if("approve"===c){if(!a.contributes.some(function(a){return a.id===b.id?(a.state="accepted",!0):void 0}))return d=N(b),d.state="accepted",a.contributes.push(d)}else if("dismiss"===c)return a.contributes=a.contributes.filter(function(a){return a.id!==b.id})},a.handleReviewerClick=function(){return a.ownPost(O)?a.showReviewPanel=!0:a.showAllReviewer||(a.showAllReviewer=!0),""},a.handlePanelClose=function(){return a.showReviewPanel=!1},a.handleContributeClick=function(a){return"a"===a.target.tagName.toLowerCase()?(B.remove("column_data"),E.track("column","visit_column","article_page_included_columns")):void 0},W=angular.element(k),a.winType=X=z.get(),K=function(){return"small"===a.winType?W.width():660},a.winSize=K(),L=function(){var b;return b=z.get(),a.winSize=K(),X!==b&&(a.winType=X=b),a.$apply()},W.on("resize",L),a.$on("$destroy",function(){return W.off("resize",L)}),O.read(),angular.element(k).width()<420&&!D.isInWX()&&(a.forceHideTipjar=!0),Y={desc:a.post.summary.replace(/<.+?>/g,"")},a.post.titleImage&&(Y.imgUrl=i("imgSize")(a.post.titleImage,"l")),-1!==c.hash().indexOf("tjshare")&&(Y.title="我在知乎赞赏了："+a.post.title,Y.link=c.absUrl().replace("tjshare","")),D.update(Y),a.$on("wechatpay:success",function(){return Y.title="我在知乎赞赏了："+a.post.title,D.update(Y)}),"#"+c.hash()===V?l(function(){return F.trackEvent(document.querySelector('[data-za-module="PostItem"]'),{action:"Share",element:"QRCode"},{share:{type:"Wechat"}}),c.hash(null)}):void 0)}])}.call(this),function(){app.controller("PostVotersCtrl",["$scope","$resource","$filter","post","linkHeaderSource","followButton","docTitle","me",function(a,b,c,d,e,f,g,h){var i,j,k;return a.post=d,i=""+d.href+"/likers",a.source=e.create(i,a.voters=[]),g.push(""+d.likesCount+" 人赞了 "+d.title),(null!=(j=d.column)?j.name:void 0)?g.push(""+d.likesCount+" 人赞了 "+d.title+" - "+d.column.name):g.push(""+d.likesCount+" 人赞了 "+d.title),"user"!==(null!=(k=d.column)?k.type:void 0)?g.setNavbarTitle({main:"<a href='"+d.column.url+"'>"+d.column.name+"</a>",sub:"首发于",ariaLabel:d.column.name,img:c("avatarUrl")(d.column.avatar,d.column.id,"small"),imghref:d.column.url,buttons:d.column.canManage?null:[f.get(a)]}):void 0}])}.call(this),function(){app.controller("ColumnEditCtrl",["$scope","$rootScope","$timeout","$anchorScroll","$routeParams","$location","$window","$interpolate","dialog","Column","column","domainConfig","globalAlert","mediator","editAvatar","docTitle","me",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r,s,t,u,v,w,x,y;return c(function(){return d()}),s=e.columnSlug,a.editMode=!!s,a.column=k,a.validatorEnabled=!1,w=function(a){var b,c;return b=(null!=(c=a.errors)?c.length:void 0)?a.errors.map(function(a){return a.message}).join("<br>"):a.message,i.message(b)},x="localhost"===f.host(),y=x?"/upload":l.avatarUploadUrl,r={type:3,return_size:"xl"},r.dest_id=s,u=function(b,c){return loadImage.readFile(b,function(b){return a.$apply(function(){return c(b.target.result)})})},t=function(b,c){return o(a,b,c)},v={loadImageMaxFileSize:15e6,imageMaxWidth:1e3,imageMaxHeight:1e3,disableImagePreview:!0,url:y,autoUpload:!0,formData:r,xhrFields:{withCredentials:!0},disableXSRFHeader:!0,add:function(a,b){var c,d;return c=b.files[0],d=c.name,u(c,function(a){return t(a,function(a){var c;return c=dataURLtoBlob(a.dataUrl),c.name=d,b.files[0]=c,b.submit()})})},processalways:function(a,b){var c;return c=b.files[b.index],c.error?m.setSync(c.error,"error"):void 0},done:function(b,c){var d;return d=c.result,d.r?i.message(d.msg):(x?a.column.avatar=d[0].avatar:(a.column.avatar.template=d.url,a.column.avatar.id=d.id),a.column.$patch({columnSlug:s},function(a){return""},function(a){return w(a.data)}))}},a.fileuploadOptions=v,a.edit=function(c){return c.$valid?a.column.$patch({columnSlug:s},function(d){return b.column&&angular.extend(b.column,d),c===a.columnUrlForm?(q.refresh(),f.url("/"+a.column.slug+"/settings").replace()):(c.$setPristine(),a.$broadcast("edit:success",c))},function(a){return w(a.data)}):void 0},a.editTopics=function(){return a.column.pendingTopics=a.column.topics=a.suggestTopics,a.column.$patch({columnSlug:s},function(b){return a.showTopicModifyDialog=!1},function(a){})},a.remove=function(a){return a.$remove(function(){return f.url("/"),m.set("专栏已删除"),n.publish("column:remove",a)})},a.$watch("column.acceptSubmission",function(b,c){return b!==c?(a.$broadcast(a.column.acceptSubmission?"contribute:enable":"contribute:disable"),a.column.$patch({columnSlug:s},function(a){return""},function(a){return w(a.data)})):void 0}),a.back=function(){return g.history.back()},a.suggestTopics=angular.copy(a.column.topics),a.suggestOptions={source:"/api/autocomplete/topics",handleInput:function(a){},handleBlur:function(a){},handleFocus:function(a){},renderRow:function(a){},render:function(a,b,c){var d,e;return e=h('<div class="row">\n  <span class="name">{{name}}</span>\n</div>'),d=c.map(function(a){return e(a.data)}).join(""),b.innerHTML=d}},p.setNavbarTitle({sub:"<a href='/"+a.column.slug+"'>"+a.column.name+"</a>",main:"管理专栏"})}])}.call(this),function(){app.controller("ColumnEditNavCtrl",["$scope","$location","$resource","sharedData","mediator",function(a,b,c,d,e){var f;return a.current=b.path().split("/")[3]||"settings",d.get("settingsNewContributeNum")?a.newContributeNum=d.get("settingsNewContributeNum"):(f=c("/api/columns/"+a.column.slug+"/contribute_requests?limit=1"),f.query(function(b,c){return a.newContributeNum=+c("X-Result-Count"),d.set("settingsNewContributeNum",a.newContributeNum)})),a.$on("contribute:disable",function(){return d.set("settingsNewContributeNum",0),a.newContributeNum=0})}])}.call(this),function(){app.controller("ColumnAuthorsEditCtrl",["$scope","$resource","$timeout","$http","dialog","column","docTitle",function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p;return a.column=f,h=b(""+a.column.href+"/authors/:slug",{slug:"@slug"}),o=function(a,b){return b.postsCount-a.postsCount},j=[],h.query({filter:"all"},function(b){var c,d,e,f;return j=b,f=[],c=[],d=[],e=null,b.forEach(function(a){switch(a.role){case"author":return c.push(a);case"editor":return f.push(a);case"contributor":return d.push(a);case"creator":return e=a}}),f.sort(o),c.sort(o),d.sort(o),e&&f.unshift(e),a.editors=f,a.authors=c,a.contributors=d,a.fetched=!0,j=j.filter(function(a){return"other"!==a.role})}),a.notMe=function(b){return b.slug!==a.me.slug},a.suggestPanelType=0,p={source:"/api/autocomplete/users",filter:function(a){return a.filter(function(a){return j.every(function(b){return b.slug!==a.slug})})}},i=function(b,c){return b.state="pending",b.role=c,a[c+"s"].push(b),j.push(b),n(!1),d.put("/api/columns/"+f.slug+"/authors/"+b.slug,{role:c}).then(null,function(b){return 403===b.status?(e.message(b.data.message||"未知错误"),j.pop(),a[c+"s"].pop()):void 0}),""},a.suggestOptionsEditor=angular.extend({select:function(a){return i(a,"editor")}},p),a.suggestOptionsAuthor=angular.extend({select:function(a){return i(a,"author")}},p),a.suggestOptionsContributor=angular.extend({select:function(a){return i(a,"contributor")}},p),a.showSuggestPanel=function(a){return n(a)},a.$on("$locationChangeStart",function(){return n(!1)}),l=angular.element(document),m=function(b){return a.$apply(function(){return angular.element(b.target).closest(".invite").length?void 0:n(!1)})},n=function(b){return l[b&&"on"||"off"]("click",m),a.suggestPanelType=b,c(function(){return angular.element(angular.element(".invite-panel")[b-1]).find("input").focus();
}),""},a.showDM=!1,a.showDMDialog=function(b){return a.showDM=!0,a.dmUser=b},k=function(b){var c;return c=function(){return b.showPermission=!1,l.off("click",c),c=null,a.$apply()}},a.toggleShowPermission=function(a){return a.showPermission=!a.showPermission,a.showPermission&&c(function(){return l.on("click",k(a))}),""},a.changeUserRole=function(b,c,e){return d.patch("/api/columns/"+f.slug+"/authors/"+b.slug,{role:c}),a[b.role+"s"].splice(e,1),b.role=c,a[c+"s"].push(b)},a.cancelUserRole=function(b,c){return d["delete"]("/api/columns/"+f.slug+"/authors/"+b.slug),a[b.role+"s"].splice(c,1),j=j.filter(function(a){return b.slug!==a.slug})},g.setNavbarTitle({sub:"<a href='/"+f.slug+"'>"+f.name+"</a>",main:"管理专栏"})}])}.call(this),function(){app.controller("ColumnPostsEditCtrl",["$scope","$resource","$window","dialog","column","linkHeaderSource","docTitle",function(a,b,c,d,e,f,g){var h;return a.posts=[],a.extra={count:0},h=b("/api/columns/"+e.slug+"/pins"),h.query(function(b){return b&&b.length&&(a.pinpost=b[0]),a.pinpost&&(a.pinpost.pin=1),a.purl="/api/columns/"+e.slug+"/posts"}),a.$on("pagination:loaded",function(b,c){return a.loaded=!0,a.pinpost&&(a.posts=a.posts.filter(function(b){return b.slug!==a.pinpost.slug}),1===c.current)?a.posts.unshift(a.pinpost):void 0}),a.cancelPin=function(b){return e.$unpin({post:b.slug},function(){return a.pinpost=null,a.$broadcast("reload")})},a.pin=function(b){return e.$pin({post:b.slug},function(){return b.pin=1,a.pinpost=b,a.$broadcast("reload")})},a.removeInclude=function(b,c){return e.$uninclude({post:b.slug},function(){return a.posts.splice(c,1),a.extra.count--})},a["delete"]=function(b,c){return e.$removePost({post:b.slug},function(){return a.posts.splice(c,1),a.extra.count--})},a.$on("pagination:change",function(a,b){return angular.element(c).scrollTop(angular.element(".settings-posts-container").offset().top-80)}),a.column=e,g.setNavbarTitle({sub:"<a href='/"+a.column.slug+"'>"+a.column.name+"</a>",main:"管理专栏"})}])}.call(this),function(){app.controller("ColumnContributesEditCtrl",["$scope","$resource","dialog","column","linkHeaderSource","docTitle",function(a,b,c,d,e,f){var g;return a.column=d,g="/api/columns/"+d.slug+"/contribute_requests",a.contributesSource=e.create(g,a.contributes=[]),a.mute=function(b,c){return d.$rejectContribute({cid:b.id},function(){return a.contributes.splice(c,1),a.contributesSource.count?a.contributesSource.count-=1:void 0})},f.setNavbarTitle({sub:"<a href='/"+d.slug+"'>"+d.name+"</a>",main:"管理专栏"})}])}.call(this),function(){app.controller("ColumnFollowersCtrl",["$scope","$resource","$filter","column","linkHeaderSource","followButton","docTitle","me",function(a,b,c,d,e,f,g,h){var i;return i=""+d.href+"/followers",a.source=e.create(i,a.followers=[]),g.setNavbarTitle({main:"<a href='"+d.url+"'>"+d.name+"</a>",ariaLabel:d.name,img:c("avatarUrl")(d.avatar,d.id,"small"),imghref:d.url,buttons:d.canManage?null:[f.get(a)]})}])}.call(this),function(){app.controller("ColumnAboutCtrl",["$scope","$resource","$filter","$sce","linkHeaderSource","me","column","docTitle","followButton",function(a,b,c,d,e,f,g,h,i){var j,k;return j=b(""+g.href+"/authors"),k=function(a,b){return a.postsCount<b.postsCount?1:a.postsCount>b.postsCount?-1:0},j.query(function(b){var c,d,e;return e=[],c=[],d=null,b.forEach(function(a){switch(a.role){case"author":case"contributor":case"other":return c.push(a);case"editor":return e.push(a);case"creator":return d=a}}),e.sort(k),c.sort(k),d&&e.unshift(d),a.editors=e,a.authors=c}),g.description=c("linky")(g.description).replace(/\&#10\;/g,"<br/>"),a.column=g,a.me=f,h.setNavbarTitle({main:"<a href='"+g.url+"'>"+g.name+"</a>",ariaLabel:g.name,img:c("avatarUrl")(g.avatar,g.id,"small"),imghref:g.url,buttons:g.canManage?null:[i.get(a)]})}])}.call(this),function(){app.controller("ColumnRequestCtrl",["$scope","$interpolate","$location","$http","globalAlert","me","mediator",function(a,b,c,d,e,f,g){var h;return a.me=f,h=b('<div class="row">\n  <span class="name">{{name}}</span>\n</div>'),a.suggestOptions={source:"/api/autocomplete/topics",handleInput:function(a){},handleBlur:function(b){return a.showTopicTips=!1,a.$apply()},handleFocus:function(b){return a.showTopicTips=!0,a.$apply()},render:function(a,b,c){var d;return d=c.map(function(a){return h(a.data)}).join(""),b.innerHTML=d}},a.column={name:"",topics:[],reason:"",bg:"",direct:""},a.submit=function(){var b;return b="/api/columns/request",a.submiting=!0,a.column.reason=[a.column.direct,a.column.bg].join("____________________"),d({method:"POST",url:b,data:a.column}).then(function(a){return c.url("/").replace(),e.set("信息已提交，我们将在三个工作日内确认并答复"),g.publish("column:request"),""},function(b){return a.submiting=!0,""})}}])}.call(this),function(){app.controller("ColumnTransferCtrl",["$scope","$interpolate","$location","$http","globalAlert","me","dialog",function(a,b,c,d,e,f,g){var h;return a.me=f,h=b('<div class="row">\n  <span class="name">{{name}}</span>\n</div>'),a.suggestOptions={source:"/api/autocomplete/topics",handleInput:function(a){},handleBlur:function(b){return a.showTopicTips=!1,a.$apply()},handleFocus:function(b){return a.showTopicTips=!0,a.$apply()},render:function(a,b,c){var d;return d=c.map(function(a){return h(a.data)}).join(""),b.innerHTML=d}},a.submit=function(){var b;return b="/api/columns/"+a.column.slug,a.submiting=!0,d({method:"POST",url:b,data:{reason:a.column.reason,topics:a.column.topics}}).then(function(b){return a.column.activateState="activated",""},function(b){return a.submiting=!1,""})},a.deleteColumn=function(){return d({method:"delete",url:"/api/columns/"+a.column.slug}).then(function(){return a.column.activateState="deleted",e.set("专栏已更新"),c.path("/u/"+f.slug).replace()}),""},a.ensureDelete=function(){return a.deleteColumn()}}])}.call(this),function(){app.controller("DraftsCtrl",["$scope","linkHeaderSource","Draft","$window","$timeout","$http","docTitle",function(a,b,c,d,e,f,g){var h,i;return i="/api/me/drafts",a.draftsSource=b.create(i,a.drafts=[]),h=function(a,b,c,e){return a.splice(e,1),b.count&&(b.count-=1),angular.element(d).scroll()},a.removeDraft=function(b,d){return b=new c(b),b.$remove(),h(a.drafts,a.draftSource,b,d),""},a.removeAllDrafts=function(){return f({method:"DELETE",url:i}).success(function(){return a.drafts=[],a.draftsSource.count=0,a.draftsSource.completed=!0})},g.setNavbarTitle({main:"草稿"})}])}.call(this),function(){app.controller("PublishCtrl",["$scope","$interpolate","$resource","$element","$http","$timeout","$location","dialog","mediator","me",function(a,b,c,d,e,f,g,h,i,j){var k,l,m,n,o,p,q,r,s,t,u,v,w;return l=c("/api/me/topics"),s=l.query(),m=function(){switch(!1){case"published"!==a.draft.state:return["topics"];default:return j.isOrg?["topics","comments","column"]:["topics","column"]}}(),o=null,a.stageController=u={get:function(){return o},go:function(a){var b;return b=m.indexOf(o)+a,this.setIndex(b)},setIndex:function(a){if(0>a||a>m.length-1)throw new Error("target publish panel stage index out of range");return o=m[a]},isFirst:function(){return 0===m.indexOf(o)},isLast:function(){return m.indexOf(o)===m.length-1},reset:function(){var b;return b="reviewing"===a.draft.state?1:0,this.setIndex(b)}},u.reset(),a.stage=u.get(),a.backStep=function(b){return b.stopPropagation(),a.stage=u.go(-1),a.canSubmit=!0},w=b('<div class="row">\n  <span class="name">{{name}}</span>\n</div>'),v="recommend",a.suggestOptions={source:"/api/autocomplete/topics",handleInput:function(a){return v=a.target.value?"search":"recommend"},handleBlur:function(a){},handleFocus:function(a){return this.renderRows(s)},render:function(a,b,c){var d;return d="","recommend"===v&&(d+='<p class="row-title">常用话题</p>'),d+=c.map(function(a){return w(a.data)}).join(""),b.innerHTML=d}},a.afterSelect=function(a){return v="recommend"},d.find(".tags").on("click",".remove-tag",function(a){return a.stopPropagation()}),a.canSubmit=!1,r=function(){return"/api/posts/{draftId}/topics".replace("{draftId}",a.draft.id)},n=function(a){return e.post(r(),a)},p=function(a){return e["delete"](r()+("/"+a.id))},a.$watchCollection("draft.topics",function(b,c){var d,e;return a.canSubmit=!!(null!=(e=a.draft.topics)?e.length:void 0),b.length>c.length?(d=c.map(function(a){return a.id}),b.some(function(a){return-1===d.indexOf(a.id)?(n(a),!0):void 0})):b.length<c.length?(d=b.map(function(a){return a.id}),c.some(function(a){return-1===d.indexOf(a.id)?(p(a),!0):void 0})):void 0}),k=c("/api/me/available_columns"),a.availableColumns=k.query(),a.canSubmitColumn=[],a.availableColumns.$promise.then(function(){return a.availableColumns.forEach(function(b){return b.canPost?a.canSubmitColumn.push(b):void 0}),0===a.availableColumns.length&&(m=m.filter(function(a){return"column"!==a})),a.$watch("stage",function(){return u.isLast()?a.submitBtnText="确定":a.submitBtnText="下一步"}),a.$watch("selectedColumn.slug",function(){var b;return"column"===a.stage&&(b=a.availableColumns.filter(function(b){return b.slug===a.selectedColumn.slug})[0],-1!==a.selectedColumn.slug)?a.canSubmit=!0:void 0})}),q=function(b){return a.availableColumns.filter(function(a){return a.slug===b})[0]},a.doCancelContribute=function(){return h.confirm(a,"确定撤销投递？","",function(){return a.$emit("draft:cancelReview")})},a.selectedColumn=angular.copy(a.draft.column)||{slug:-1},t=function(){var b;return b=q(a.selectedColumn.slug),a.publish(b,a.commentPermission)},a.submit=function(){return u.isLast()?t():(a.stage=u.go(1),"column"===a.stage?a.canSubmit=-1!==a.selectedColumn.slug:"comments"===a.stage?(a.commentPermission="anyone",a.canSubmit=!0):void 0)},a.handlePanelOpen=function(){return i.publish("navbar:menuDisable"),0===a.draft.topics.length&&f(function(){return d.find(".tag-suggestion-container .input-container input").focus()}),""},a.handlePanelClose=function(){return i.publish("navbar:menuEnable")},a.getTitle=function(){switch(a.draft.state){case"reviewing":return"修改";case"published":return"更新";default:return"发布"}}}])}.call(this),function(){app.controller("ConversationDialogCtrl",["$scope","$rootScope","$http","$timeout","element","linkHeaderSource","me","entry","dlg",function(a,b,c,d,e,f,g,h,i){var j,k;return a.url=""+h.href+"/conversation",a.commentsStatus={canComment:!1},k=new zh.ui.Scroller,j=[],a.pending=!0,a.$on("commentLoaded",function(c,f,h){var l,m,n;return a.pending=!1,n=h.filter(function(a){return!a.deleted}),j=n.map(function(a){return a.author}),j.some(function(a){return a.slug===g.slug})&&(a.commentsStatus.canComment=!0,a.replyAuthor=j.find(function(a){return a.slug!==g.slug}),a.replyAuthor?(m=n.reverse().filter(function(b){return b.author.slug===a.replyAuthor.slug})[0],a.replyCommentHref=""+m.href+"/reply"):(l=n[n.length-1],a.replyCommentHref=l.href.replace(/\/\d+$/,"/"+l.inReplyToCommentId)),a.placeholder="回复 "+a.replyAuthor.name,a.needReview&&(a.placeholder+="，评论由机构筛选后公开")),d(function(){var a;return a=e.find(".comment-list-container"),e.find(".comment-list").height()<a.height()&&!b.supportTouch&&a.addClass("shrink-list"),k.decorate(f.find(".comment-list-container")[0]),k.enter(),k.update(),i.reposition()})}),a.$on("commentMoreLoaded",function(a){return k.update(),i.reposition()}),a.$on("$destroy",function(){return null!=k&&k.exit(),null!=k?k.dispose():void 0})}])}.call(this),function(){app.factory("editAvatar",["dialog",function(a){return function(b,c,d){return a.fromUrl("/scripts/avatar/avatar-editor.html",{controller:"AvatarEditorCtrl",scope:b,resolve:{src:c,submit:d}}).then(function(a){return a.open()})}}]),app.controller("AvatarEditorCtrl",["$scope","src","submit","element",function(a,b,c,d){var e,f;return f=0===b.indexOf("data:image"),e=new zh.ui.ImageCrop(b),e.render(d.find(".modal-dialog-content")[0]),a.submit=function(){var a;return a=f?{dataUrl:e.toDataUrl()}:{rect:e.getRect()},c(a)}}])}.call(this),function(){app.factory("debounce",["$timeout",function(a){return function(b,c){var d;return d=null,function(){return a.cancel(d),d=a(c.apply.bind(c,this,arguments),b)}}}])}.call(this),function(){app.factory("memoize",["$timeout",function(a){return function(a){var b;return b={},function(c){return b[c]?b[c]:b[c]=a(c)}}}])}.call(this),function(){app.factory("support",function(){var a;return a=document.body.style,{cssAnimation:["animation","webkitAnimation"].some(function(b){return b in a}),backgroundSize:"backgroundSize"in a}})}.call(this),function(){app.factory("viewport",["$window","$timeout",function(a,b){var c,d,e,f,g,h,i;return c=angular.element(a),d="onInViewOnceHandler",e=function(a,b){return!(a.right<b.left||a.bottom<b.top||a.left>b.right||a.top>b.bottom)},h=function(){return{left:0,right:c.width(),top:0,bottom:c.height()}},f=function(a){var b,c;return c=h(),b=(a[0]||a).getBoundingClientRect(),e(c,b)},i=function(a){var b;return b=a.data(d),b?c.off("scroll",b):void 0},g=function(a,e){var g;return g=function(){return f(a)?(e&&e(),c.off("scroll",g)):void 0},a.data(d,g),c.on("scroll",g),b(g,100)},{isElementInView:f,unlisten:i,onInViewOnce:g}}])}.call(this),function(){app.factory("wx",["$http","$rootScope","$location","$timeout","$q","siteConfig",function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p;return o=["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone"],g={COMPLETED:0,UNINITIALIZED:1,FETCHING_SDK:2,AUTHING:3},p=g.UNINITIALIZED,m=null,h=null,k=function(){return{title:document.title,link:c.absUrl(),desc:"随心写作，自由表达",imgUrl:"https://zhstatic.zhihu.com/assets/zhuanlan/icon_120.png",type:"link"}},n=function(){return m?(o.forEach(function(a){return window.wx[a](m)}),m=null):void 0},l=function(){return/micromessenger/.test(navigator.userAgent.toLowerCase())},i=function(){var b;return p=g.AUTHING,b=a.get("/api/wechat/jssdkconfig",{params:{url:m.link}}).then(function(a){var b;return b=a.data,h=b.appId,window.wx.config({debug:!1,appId:b.appId,timestamp:b.timestamp,nonceStr:b.nonceStr,signature:b.signature,jsApiList:o.slice()}),window.wx.ready(n),p=g.COMPLETED})},j=function(){return p=g.FETCHING_SDK,$.ajax({url:"https://res.wx.qq.com/open/js/jweixin-1.0.0.js",dataType:"script",cache:!0,success:function(){return i()}})},{init:function(){if(l())switch(m=m||k(),p){case g.UNINITIALIZED:return j();case g.COMPLETED:return i()}},update:function(a){return null==a&&(a={}),l()?(m=angular.extend({},k(),a),p===g.COMPLETED?window.wx.ready(n):void 0):void 0},doOauth:function(){var a;return l()?(a=location.href,window.localStorage.setItem(f.tipjarOpenKey,1),location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+h+"&redirect_uri="+encodeURIComponent(f.oauthUrl+"&redirect="+encodeURIComponent(a))+"&response_type=code&scope=snsapi_base&state=1#wechat_redirect"):void 0},isInWX:l,pay:function(a){var b;return b=e.defer(),p!==g.COMPLETED?void b.reject():(window.wx.ready(function(){return wx.chooseWXPay({appId:a.appId,timestamp:a.timeStamp,nonceStr:a.nonceStr,"package":a["package"],signType:a.signType,paySign:a.paySign,success:function(a){return b.resolve()},fail:function(a){return alert("支付未完成，请重试"),b.reject()},cancel:function(){return b.reject()}})}),b.promise)}}}])}.call(this),function(){app.factory("openInApp",["$window",function(a){var b,c,d,e;return d="zhihu://",e=a.navigator.userAgent,c=function(a){var b,c,d;return d=e.match(/Chrome\/(\d+)/),d&&(b=d[1]),b>=25?location.href=a.replace(/^zhihu/,"intent")+"/#Intent;scheme=zhihu;package=com.zhihu.android;end":(c=document.createElement("iframe"),c.hidden=!0,c.src=a,document.body.appendChild(c))},b=function(a){return-1===a.indexOf(d)&&(a=d+a),/android/i.test(e)?c(a):location.href=a},{openPost:function(a){return a?b("articles/"+a):void 0}}}])}.call(this),function(){app.factory("getScript",["$q",function(a){return function(b,c){var d,e;return null==c&&(c=!1),d=a.defer(),e=document.createElement("script"),e.async=c,e.onload=d.resolve,e.onerror=function(){return new Error("Failed to load script: "+b)},e.src=b,document.body.appendChild(e),d.promise}}])}.call(this),function(){app.service("bracketBlinkFix",["$rootScope","$window","$timeout",function(a,b,c){var d,e;return e=/Mobile/.test(b.navigator.userAgent),d=function(){var b,d;return d=angular.element("[ng-view]"),b=function(){return d.addClass("hidden"),c(function(){return d.removeClass("hidden")})},a.$on("$routeChangeSuccess",b),a.$on("$routeChangeError",b)},e?d():void 0}])}.call(this);